<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServiceIA - Socket.IO + OpenAI</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .chat-container {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.bot {
            background: #e0e0e0;
            color: #333;
        }

        .message-label {
            font-size: 0.75em;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #667eea;
        }

        button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 10px;
        }

        .message.agent-action {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .message.agent-selection {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 3px solid #17a2b8;
            font-size: 0.9em;
        }

        .message.agent-message {
            background: #e7f3ff;
            color: #004085;
            border-left: 3px solid #0056b3;
            font-size: 0.9em;
            margin: 10px 0;
        }

        .message.agent-message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
        }

        .message.agent-message code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .message.terminal-output {
            background: #1e1e1e;
            border-left: 3px solid #4ec9b0;
            margin: 10px 0;
        }

        .message.terminal-output .message-label {
            background: #252526;
            color: #4ec9b0;
            padding: 8px 12px;
            border-radius: 5px 5px 0 0;
            font-weight: 600;
        }

        .terminal-content {
            scrollbar-width: thin;
            scrollbar-color: #4ec9b0 #1e1e1e;
        }

        .terminal-content::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-content::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .terminal-content::-webkit-scrollbar-thumb {
            background: #4ec9b0;
            border-radius: 4px;
        }

        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #5ed9c9;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h1 style="margin: 0;">ü§ñ ServiceIA</h1>
            <div style="display: flex; gap: 10px;">
                <button onclick="toggleAgentsList()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='#218838';" onmouseout="this.style.background='#28a745';">üìã Agentes</button>
                <button onclick="toggleTokensList()" style="background: #ffc107; color: #333; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='#e0a800';" onmouseout="this.style.background='#ffc107';">üí∞ Tokens</button>
                <button onclick="toggleLogsList()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s;" onmouseover="this.style.background='#138496';" onmouseout="this.style.background='#17a2b8';">üìù Logs</button>
                <a href="/monitor" style="color: #667eea; text-decoration: none; font-size: 0.9em; padding: 8px 15px; border: 2px solid #667eea; border-radius: 8px; transition: all 0.3s;" onmouseover="this.style.background='#667eea'; this.style.color='white';" onmouseout="this.style.background='transparent'; this.style.color='#667eea';">üîç Monitor</a>
            </div>
        </div>
        <p class="subtitle">Comunica√ß√£o via Socket.IO com OpenAI</p>
        
        <div id="status" class="status disconnected">
            Desconectado
        </div>

        <!-- Lista de Agentes (oculta por padr√£o) -->
        <div id="agentsList" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e0e0e0; max-height: 400px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 1.3em; color: #333;">üìã Agentes Dispon√≠veis</h2>
                <button onclick="toggleAgentsList()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚úï Fechar</button>
            </div>
            <div id="agentsContent">Carregando agentes...</div>
        </div>

        <!-- Hist√≥rico de Tokens (oculto por padr√£o) -->
        <div id="tokensList" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border: 2px solid #ffc107; max-height: 500px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 1.3em; color: #333;">üí∞ Hist√≥rico de Tokens</h2>
                <button onclick="toggleTokensList()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚úï Fechar</button>
            </div>
            <div id="tokensContent">Carregando tokens...</div>
        </div>

        <!-- Hist√≥rico de Logs (oculto por padr√£o) -->
        <div id="logsList" style="display: none; margin-bottom: 20px; padding: 15px; background: #d1ecf1; border-radius: 10px; border: 2px solid #17a2b8; max-height: 600px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 1.3em; color: #333;">üìù Hist√≥rico de Logs</h2>
                <button onclick="toggleLogsList()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚úï Fechar</button>
            </div>
            <div id="logsContent">Carregando logs...</div>
        </div>

        <div class="chat-container" id="chat">
            <div class="message bot">
                <div class="message-label">Sistema</div>
                <div>Conecte-se ao servidor para come√ßar a conversar!</div>
            </div>
        </div>

        <div class="input-container">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Digite sua mensagem (ex: Hello)..."
                autocomplete="off"
            >
            <button id="sendButton" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:3000');
        const chatContainer = document.getElementById('chat');
        const statusDiv = document.getElementById('status');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Eventos de conex√£o
        socket.on('connect', () => {
            statusDiv.textContent = 'Conectado';
            statusDiv.className = 'status connected';
            addMessage('Sistema', 'Conectado ao servidor!', 'bot');
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'Desconectado';
            statusDiv.className = 'status disconnected';
            addMessage('Sistema', 'Desconectado do servidor', 'bot');
        });

        // Recebe informa√ß√£o sobre qual agente foi selecionado
        socket.on('agent_selected', (data) => {
            addAgentSelection(data.agentName, data.description);
        });

        // Recebe resposta do servidor
        socket.on('response', (data) => {
            removeLoading();
            removeAgentActions();
            const senderLabel = data.agentName ? `IA (${data.agentName})` : 'IA';
            
            // Adiciona mensagem principal
            addMessage(senderLabel, data.message, 'bot');
            
            // Adiciona informa√ß√µes de tokens de forma compacta se dispon√≠veis
            if (data.tokenUsage || data.accumulatedTokenUsage) {
                const tokenDiv = document.createElement('div');
                tokenDiv.className = 'message';
                tokenDiv.style.background = 'rgba(40, 167, 69, 0.05)';
                tokenDiv.style.border = '1px solid rgba(40, 167, 69, 0.2)';
                tokenDiv.style.marginTop = '5px';
                tokenDiv.style.padding = '6px 10px';
                tokenDiv.style.fontSize = '0.75em';
                
                let tokenContent = '<div style="display: flex; justify-content: space-between; align-items: center;">';
                tokenContent += '<span>üí∞ Tokens:</span>';
                
                if (data.tokenUsage) {
                    tokenContent += `<span style="margin-left: 10px;">Esta: ${data.tokenUsage.totalTokens}</span>`;
                }
                
                if (data.accumulatedTokenUsage) {
                    tokenContent += `<span style="margin-left: 10px; font-weight: 600; color: #28a745;">Total: ${data.accumulatedTokenUsage.totalTokens}</span>`;
                }
                
                tokenContent += '</div>';
                tokenDiv.innerHTML = tokenContent;
                chatContainer.appendChild(tokenDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });

        // Recebe erros
        socket.on('error', (data) => {
            removeLoading();
            removeAgentActions();
            addMessage('Erro', data.message, 'bot');
        });

        // Recebe a√ß√µes do agente em tempo real
        socket.on('agent_action', (data) => {
            addAgentAction(data.action);
        });

        // Recebe confirma√ß√£o de conclus√£o de a√ß√£o
        socket.on('agent_action_complete', (data) => {
            updateAgentAction(data.action, data.success, data.result);
        });

        // Logs de debug removidos - apenas logs no servidor

        // Recebe mensagens trocadas pelos agentes
        socket.on('agent_message', (data) => {
            addAgentMessage(data);
        });

        // Recebe informa√ß√µes de tokens em tempo real
        socket.on('token_usage', (data) => {
            // Adiciona uma mensagem de token usage na interface
            const tokenDiv = document.createElement('div');
            tokenDiv.className = 'message token-usage';
            tokenDiv.style.background = 'rgba(102, 126, 234, 0.05)';
            tokenDiv.style.border = '1px solid rgba(102, 126, 234, 0.2)';
            tokenDiv.style.fontSize = '0.75em';
            tokenDiv.style.padding = '6px 10px';
            tokenDiv.style.marginBottom = '5px';
            tokenDiv.innerHTML = `
                <div class="message-label" style="font-size: 0.85em;">üí∞ Tokens</div>
                <div style="font-size: 0.85em;">
                    Mensagem: ${data.tokens.totalTokens} | Total: ${data.accumulated.totalTokens}
                </div>
            `;
            chatContainer.appendChild(tokenDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove ap√≥s 5 segundos para n√£o poluir a interface
            setTimeout(() => {
                if (tokenDiv && tokenDiv.parentNode) {
                    tokenDiv.remove();
                }
            }, 5000);
        });

        // Recebe sa√≠da do terminal em tempo real
        socket.on('terminal_output', (data) => {
            addTerminalOutput(data);
        });

        function addMessage(sender, message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="message-label">${sender}</div>
                <div>${message}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Processando...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        function addAgentAction(actionText) {
            // Remove a√ß√µes anteriores se existirem
            removeAgentActions();
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'message agent-action';
            actionDiv.id = 'agent-action';
            actionDiv.innerHTML = `
                <div class="message-label">ü§ñ Agente</div>
                <div>${actionText}</div>
            `;
            chatContainer.appendChild(actionDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateAgentAction(actionText, success, resultPreview) {
            const actionDiv = document.getElementById('agent-action');
            if (actionDiv) {
                const icon = success ? '‚úÖ' : '‚ùå';
                let content = `${icon} ${actionText}`;
                if (resultPreview) {
                    content += `<br><small style="opacity: 0.7;">Resultado: ${escapeHtml(resultPreview)}</small>`;
                }
                actionDiv.innerHTML = `
                    <div class="message-label">ü§ñ Agente</div>
                    <div>${content}</div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Remove ap√≥s 3 segundos
                setTimeout(() => {
                    if (actionDiv && actionDiv.parentNode) {
                        actionDiv.remove();
                    }
                }, 3000);
            }
        }


        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Container para o terminal
        let terminalContainer = null;

        function addTerminalOutput(data) {
            // Se for in√≠cio de um novo comando, limpa o terminal anterior
            if (data.type === 'start') {
                if (terminalContainer && terminalContainer.parentNode) {
                    terminalContainer.remove();
                }
                terminalContainer = null;
            }

            // Cria container do terminal se n√£o existir
            if (!terminalContainer) {
                terminalContainer = document.createElement('div');
                terminalContainer.className = 'message terminal-output';
                terminalContainer.id = 'terminal-output';
                terminalContainer.innerHTML = `
                    <div class="message-label">üíª Terminal</div>
                    <div class="terminal-content" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; max-height: 500px; overflow-y: auto; line-height: 1.5;"></div>
                `;
                chatContainer.appendChild(terminalContainer);
            }

            const terminalContent = terminalContainer.querySelector('.terminal-content');
            
            if (!terminalContent) return;

            // Processa o conte√∫do baseado no tipo
            let content = '';
            let color = '#d4d4d4'; // Cor padr√£o (cinza claro)

            switch (data.type) {
                case 'start':
                    color = '#4ec9b0'; // Verde √°gua
                    content = escapeHtml(data.content);
                    break;
                case 'stdout':
                    color = '#d4d4d4'; // Cinza claro (sa√≠da normal)
                    content = escapeHtml(data.content);
                    break;
                case 'stderr':
                    color = '#f48771'; // Laranja (erros/avisos)
                    content = escapeHtml(data.content);
                    break;
                case 'success':
                    color = '#4ec9b0'; // Verde √°gua
                    content = escapeHtml(data.content);
                    break;
                case 'error':
                    color = '#f48771'; // Laranja/vermelho
                    content = escapeHtml(data.content);
                    break;
                default:
                    content = escapeHtml(data.content);
            }

            // Adiciona o conte√∫do com a cor apropriada
            const span = document.createElement('span');
            span.style.color = color;
            span.textContent = content;
            terminalContent.appendChild(span);

            // Auto-scroll para o final
            terminalContent.scrollTop = terminalContent.scrollHeight;

            // Se o comando terminou, marca mas mant√©m vis√≠vel
            if (data.isComplete) {
                // Adiciona uma linha separadora visual
                const separator = document.createElement('div');
                separator.style.marginTop = '10px';
                separator.style.paddingTop = '10px';
                separator.style.borderTop = '1px solid #4ec9b0';
                separator.style.opacity = '0.3';
                terminalContent.appendChild(separator);
            }
        }

        function addAgentMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message';
            
            let icon = 'üí¨';
            let title = 'Mensagem do Agente';
            let content = '';
            
            if (data.type === 'user') {
                icon = 'üë§';
                title = 'Mensagem do Usu√°rio (enviada ao agente)';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">üìù Mensagem:</div>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">${escapeHtml(data.message)}</div>`;
            } else if (data.type === 'assistant') {
                icon = 'ü§ñ';
                title = 'Resposta do Agente';
                
                // Adiciona informa√ß√µes de tokens se dispon√≠veis (compacto)
                let tokenInfo = '';
                if (data.tokenUsage) {
                    tokenInfo = `<div style="margin-top: 5px; padding: 4px 6px; background: rgba(40, 167, 69, 0.08); border-radius: 3px; font-size: 0.7em; color: #666;">
                        üí∞ ${data.tokenUsage.totalTokens} tokens
                    </div>`;
                }
                
                content = `<div style="font-weight: 600; margin-bottom: 5px;">üí¨ Resposta:</div>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px; white-space: pre-wrap;">${escapeHtml(data.message)}</div>
                    ${tokenInfo}`;
            } else if (data.type === 'function_calls') {
                icon = 'üîß';
                title = 'Fun√ß√µes que o Agente quer Executar';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">Fun√ß√µes solicitadas:</div>`;
                data.toolCalls.forEach((tc, index) => {
                    content += `<div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                        <strong>${index + 1}. ${tc.functionName}</strong><br>
                        <small>Argumentos:</small><pre style="font-size: 0.85em; margin: 5px 0; overflow-x: auto;">${escapeHtml(JSON.stringify(tc.arguments, null, 2))}</pre>
                    </div>`;
                });
            } else if (data.type === 'function_result') {
                icon = '‚úÖ';
                title = `Resultado da Fun√ß√£o: ${data.functionName}`;
                content = `<div style="font-weight: 600; margin-bottom: 5px;">Fun√ß√£o executada: <code>${data.functionName}</code> (${data.executionTime}ms)</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Argumentos:</div>
                    <pre style="font-size: 0.85em; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 5px; margin-bottom: 5px; overflow-x: auto;">${escapeHtml(JSON.stringify(data.arguments, null, 2))}</pre>
                    <div style="font-weight: 600; margin-bottom: 5px;">Resultado:</div>
                    <div style="background: ${data.success ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'}; padding: 8px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${escapeHtml(data.result)}</div>`;
            } else if (data.type === 'function_outputs') {
                icon = 'üì§';
                title = 'Resultados Enviados de Volta ao Agente';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">${data.outputsCount} resultado(s) enviado(s):</div>`;
                data.outputs.forEach((output, index) => {
                    content += `<div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                        <strong>${index + 1}. Tool Call ID: ${output.toolCallId}</strong><br>
                        <small>Tamanho: ${output.outputLength} caracteres</small><br>
                        <div style="margin-top: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-size: 0.9em;">${escapeHtml(output.output)}</div>
                    </div>`;
                });
            }
            
            let detailsHtml = '';
            if (data.details && Object.keys(data.details).length > 0) {
                detailsHtml = '<details style="margin-top: 5px;"><summary style="cursor: pointer; font-size: 0.85em; opacity: 0.7;">Detalhes t√©cnicos</summary><pre style="font-size: 0.75em; margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow-x: auto;">' + 
                    escapeHtml(JSON.stringify(data.details, null, 2)) + '</pre></details>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-label">${icon} ${title}</div>
                <div>${content}${detailsHtml}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeAgentActions() {
            const actionDiv = document.getElementById('agent-action');
            if (actionDiv) {
                actionDiv.remove();
            }
        }

        function addAgentSelection(agentName, description) {
            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'message agent-selection';
            selectionDiv.innerHTML = `
                <div class="message-label">ü§ñ Usando Agente</div>
                <div><strong>${agentName}</strong>: ${description}</div>
            `;
            chatContainer.appendChild(selectionDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove ap√≥s 3 segundos
            setTimeout(() => {
                if (selectionDiv && selectionDiv.parentNode) {
                    selectionDiv.remove();
                }
            }, 3000);
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('Voc√™', message, 'user');
            addLoading();
            messageInput.value = '';
            sendButton.disabled = true;

            socket.emit('message', { message: message });

            setTimeout(() => {
                sendButton.disabled = false;
                messageInput.focus();
            }, 100);
        }

        // Envia mensagem ao pressionar Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Foca no input quando a p√°gina carrega
        window.onload = () => {
            messageInput.focus();
        };

        // Fun√ß√£o para alternar visibilidade da lista de agentes
        function toggleAgentsList() {
            const agentsList = document.getElementById('agentsList');
            if (agentsList.style.display === 'none') {
                agentsList.style.display = 'block';
                loadAgents();
            } else {
                agentsList.style.display = 'none';
            }
        }

        // Carrega e exibe a lista de agentes
        async function loadAgents() {
            const agentsContent = document.getElementById('agentsContent');
            agentsContent.innerHTML = 'Carregando agentes...';
            
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                let html = '';
                
                // Main Selector
                if (data.mainSelector) {
                    let toolsHtml = '';
                    if (data.mainSelector.tools && data.mainSelector.tools.length > 0) {
                        toolsHtml = `<div style="margin-top: 8px; padding: 6px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 0.85em;">
                            <strong>üîß Ferramentas (${data.mainSelector.tools.length}):</strong><br>
                            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${data.mainSelector.tools.map(tool => `<span style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${escapeHtml(tool)}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                    
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: #667eea; color: white; border-radius: 8px;">
                        <strong>üéØ Main Selector</strong><br>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            <strong>${escapeHtml(data.mainSelector.name)}</strong><br>
                            ${escapeHtml(data.mainSelector.description)}
                            ${toolsHtml}
                        </div>
                    </div>`;
                }
                
                // Grupos
                if (data.groups && data.groups.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong style="font-size: 1.1em;">üì¶ Grupos</strong></div>';
                    
                    data.groups.forEach(group => {
                        html += `<div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #28a745;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #28a745;">${escapeHtml(group.name)}</div>
                            
                            <div style="margin-left: 15px; margin-bottom: 8px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 5px;">
                                <strong>üéØ Orquestrador:</strong> ${escapeHtml(group.orchestrator.name)}<br>
                                <small style="color: #666;">${escapeHtml(group.orchestrator.description)}</small>`;
                        
                        if (group.orchestrator.tools && group.orchestrator.tools.length > 0) {
                            html += `<div style="margin-top: 6px; font-size: 0.85em;">
                                <strong>üîß Ferramentas (${group.orchestrator.tools.length}):</strong><br>
                                <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${group.orchestrator.tools.map(tool => `<span style="background: rgba(102, 126, 234, 0.2); padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${escapeHtml(tool)}</span>`).join('')}
                                </div>
                            </div>`;
                        }
                        
                        html += `</div>
                            <div style="margin-left: 15px;">
                                <strong>ü§ñ Agentes (${group.agents.length}):</strong><br>`;
                        
                        group.agents.forEach(agent => {
                            let agentToolsHtml = '';
                            if (agent.tools && agent.tools.length > 0) {
                                agentToolsHtml = `<div style="margin-top: 4px; font-size: 0.8em;">
                                    <strong>üîß Ferramentas:</strong>
                                    <div style="margin-top: 3px; display: flex; flex-wrap: wrap; gap: 3px;">
                                        ${agent.tools.map(tool => `<span style="background: rgba(0,0,0,0.1); padding: 2px 5px; border-radius: 3px; font-size: 0.75em;">${escapeHtml(tool)}</span>`).join('')}
                                    </div>
                                </div>`;
                            }
                            
                            html += `<div style="margin-top: 5px; padding: 6px; background: rgba(0,0,0,0.05); border-radius: 3px; font-size: 0.9em;">
                                <strong>${escapeHtml(agent.name)}</strong><br>
                                <small style="color: #666;">${escapeHtml(agent.description)}</small>
                                ${agentToolsHtml}
                            </div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                }
                
                // Fallback Agent
                if (data.fallbackAgent) {
                    let fallbackToolsHtml = '';
                    if (data.fallbackAgent.tools && data.fallbackAgent.tools.length > 0) {
                        fallbackToolsHtml = `<div style="margin-top: 8px; padding: 6px; background: rgba(0,0,0,0.1); border-radius: 5px; font-size: 0.85em;">
                            <strong>üîß Ferramentas (${data.fallbackAgent.tools.length}):</strong><br>
                            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${data.fallbackAgent.tools.map(tool => `<span style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${escapeHtml(tool)}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                    
                    html += `<div style="margin-top: 15px; padding: 10px; background: #ffc107; color: #333; border-radius: 8px;">
                        <strong>üîÑ Fallback Agent</strong><br>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            <strong>${escapeHtml(data.fallbackAgent.name)}</strong><br>
                            ${escapeHtml(data.fallbackAgent.description)}
                            ${fallbackToolsHtml}
                        </div>
                    </div>`;
                }
                
                html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px; text-align: center; font-size: 0.85em; color: #666;">
                    Total: <strong>${data.total}</strong> agente(s) configurado(s)
                </div>`;
                
                agentsContent.innerHTML = html;
            } catch (error) {
                agentsContent.innerHTML = `<div style="color: #dc3545; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px;">
                    Erro ao carregar agentes: ${error.message}
                </div>`;
            }
        }

        // Fun√ß√£o para alternar visibilidade do hist√≥rico de tokens
        function toggleTokensList() {
            const tokensList = document.getElementById('tokensList');
            if (tokensList.style.display === 'none') {
                tokensList.style.display = 'block';
                loadTokens();
            } else {
                tokensList.style.display = 'none';
            }
        }

        // Carrega e exibe o hist√≥rico de tokens
        async function loadTokens() {
            const tokensContent = document.getElementById('tokensContent');
            tokensContent.innerHTML = 'Carregando tokens...';
            
            try {
                const response = await fetch('/api/tokens');
                const data = await response.json();
                
                let html = '';
                
                // Total de tokens
                if (data.totalTokens) {
                    const totalCost = data.totalCost || { promptCost: 0, completionCost: 0, totalCost: 0 };
                    html += `<div style="margin-bottom: 20px; padding: 15px; background: #28a745; color: white; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">üí∞ Total de Tokens</div>
                        <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Prompt</div>
                                <div style="font-size: 1.3em; font-weight: bold;">${data.totalTokens.promptTokens.toLocaleString()}</div>
                                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${totalCost.promptCost.toFixed(4)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Completion</div>
                                <div style="font-size: 1.3em; font-weight: bold;">${data.totalTokens.completionTokens.toLocaleString()}</div>
                                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${totalCost.completionCost.toFixed(4)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Total</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.totalTokens.totalTokens.toLocaleString()}</div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 3px; font-weight: bold;">$${totalCost.totalCost.toFixed(4)}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Hist√≥rico de entradas
                if (data.entries && data.entries.length > 0) {
                    html += `<div style="margin-bottom: 10px;"><strong style="font-size: 1.1em;">üìú Hist√≥rico (${data.entries.length} intera√ß√£o${data.entries.length > 1 ? '√µes' : ''})</strong></div>`;
                    
                    // Mostra as √∫ltimas 20 entradas (mais recentes primeiro)
                    const entries = data.entries.slice().reverse().slice(0, 20);
                    
                    entries.forEach((entry, index) => {
                        const date = new Date(entry.timestamp);
                        const dateStr = date.toLocaleString('pt-BR');
                        
                        html += `<div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: #333;">${escapeHtml(entry.agentName)}</strong>
                                    <div style="font-size: 0.85em; color: #666; margin-top: 3px;">${escapeHtml(entry.message)}</div>
                                </div>
                                <div style="font-size: 0.75em; color: #999; text-align: right;">
                                    ${dateStr}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div style="padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">Esta Intera√ß√£o</div>
                                    <div style="font-size: 0.85em;">
                                        <span style="color: #007bff;">Prompt:</span> ${entry.tokenUsage.promptTokens.toLocaleString()}<br>
                                        <span style="color: #28a745;">Completion:</span> ${entry.tokenUsage.completionTokens.toLocaleString()}<br>
                                        <span style="color: #333; font-weight: bold;">Total:</span> ${entry.tokenUsage.totalTokens.toLocaleString()}
                                        ${entry.cost ? `<br><span style="color: #ffc107; font-weight: bold; margin-top: 3px; display: block;">üí∞ Custo: $${entry.cost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>
                                </div>
                                <div style="padding: 8px; background: rgba(40, 167, 69, 0.1); border-radius: 5px;">
                                    <div style="font-size: 0.8em; color: #666; margin-bottom: 4px;">Acumulado</div>
                                    <div style="font-size: 0.85em;">
                                        <span style="color: #007bff;">Prompt:</span> ${entry.accumulatedTokenUsage.promptTokens.toLocaleString()}<br>
                                        <span style="color: #28a745;">Completion:</span> ${entry.accumulatedTokenUsage.completionTokens.toLocaleString()}<br>
                                        <span style="color: #333; font-weight: bold;">Total:</span> ${entry.accumulatedTokenUsage.totalTokens.toLocaleString()}
                                        ${entry.accumulatedCost ? `<br><span style="color: #ffc107; font-weight: bold; margin-top: 3px; display: block;">üí∞ Custo: $${entry.accumulatedCost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-size: 0.7em; color: #999; margin-top: 6px;">
                                Thread: ${entry.threadId.substring(0, 20)}...
                            </div>
                        </div>`;
                    });
                    
                    if (data.entries.length > 20) {
                        html += `<div style="text-align: center; padding: 10px; color: #666; font-size: 0.9em;">
                            Mostrando √∫ltimas 20 de ${data.entries.length} intera√ß√µes
                        </div>`;
                    }
                } else {
                    html += `<div style="padding: 20px; text-align: center; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                        <div>Nenhuma intera√ß√£o registrada ainda.</div>
                    </div>`;
                }
                
                // √öltima atualiza√ß√£o
                if (data.lastUpdated) {
                    const lastUpdate = new Date(data.lastUpdated);
                    html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px; text-align: center; font-size: 0.85em; color: #666;">
                        √öltima atualiza√ß√£o: ${lastUpdate.toLocaleString('pt-BR')}
                    </div>`;
                }
                
                tokensContent.innerHTML = html;
            } catch (error) {
                tokensContent.innerHTML = `<div style="color: #dc3545; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px;">
                    Erro ao carregar tokens: ${error.message}
                </div>`;
            }
        }

        // Fun√ß√£o para alternar visibilidade do hist√≥rico de logs
        function toggleLogsList() {
            const logsList = document.getElementById('logsList');
            if (logsList.style.display === 'none') {
                logsList.style.display = 'block';
                loadLogs();
            } else {
                logsList.style.display = 'none';
            }
        }

        // Fun√ß√£o para obter cor baseada no tipo de log
        function getLogTypeColor(type) {
            const colors = {
                'connection': '#28a745',
                'disconnection': '#dc3545',
                'agent_selection': '#667eea',
                'message_sent': '#17a2b8',
                'message_received': '#17a2b8',
                'tool_execution': '#ffc107',
                'tool_result': '#ffc107',
                'run_status': '#6c757d',
                'error': '#dc3545',
                'response': '#28a745',
                'token_usage': '#ffc107',
                'monitoring': '#6f42c1'
            };
            return colors[type] || '#6c757d';
        }

        // Fun√ß√£o para obter √≠cone baseado no tipo de log
        function getLogTypeIcon(type) {
            const icons = {
                'connection': 'üîå',
                'disconnection': 'üîå',
                'agent_selection': 'ü§ñ',
                'message_sent': 'üì§',
                'message_received': 'üì•',
                'tool_execution': 'üîß',
                'tool_result': '‚úÖ',
                'run_status': '‚öôÔ∏è',
                'error': '‚ùå',
                'response': 'üí¨',
                'token_usage': 'üí∞',
                'monitoring': 'üëÅÔ∏è'
            };
            return icons[type] || 'üìù';
        }

        // Carrega e exibe o hist√≥rico de logs
        async function loadLogs() {
            const logsContent = document.getElementById('logsContent');
            logsContent.innerHTML = 'Carregando logs...';
            
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                let html = '';
                
                // Estat√≠sticas
                if (data.statistics) {
                    html += `<div style="margin-bottom: 20px; padding: 15px; background: #17a2b8; color: white; border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">üìä Estat√≠sticas</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Conex√µes</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalConnections || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Mensagens</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalMessages || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Tools</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalToolExecutions || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Erros</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalErrors || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Tokens</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${(data.statistics.totalTokens || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Hist√≥rico de logs
                if (data.entries && data.entries.length > 0) {
                    html += `<div style="margin-bottom: 10px;">
                        <strong style="font-size: 1.1em;">üìú Logs (${data.entries.length} entrada${data.entries.length > 1 ? 's' : ''})</strong>
                        <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                            Mostrando √∫ltimas 50 entradas (mais recentes primeiro)
                        </div>
                    </div>`;
                    
                    // Mostra as √∫ltimas 50 entradas (mais recentes primeiro)
                    const logs = data.entries.slice().reverse().slice(0, 50);
                    
                    logs.forEach((log, index) => {
                        const date = new Date(log.timestamp);
                        const dateStr = date.toLocaleString('pt-BR');
                        const typeColor = getLogTypeColor(log.type);
                        const typeIcon = getLogTypeIcon(log.type);
                        
                        html += `<div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${typeColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">${typeIcon}</span>
                                        <strong style="color: ${typeColor}; text-transform: uppercase; font-size: 0.9em;">${escapeHtml(log.type)}</strong>
                                        ${log.agentName ? `<span style="font-size: 0.85em; color: #666;">ü§ñ ${escapeHtml(log.agentName)}</span>` : ''}
                                    </div>
                                    ${log.message ? `<div style="font-size: 0.85em; color: #333; margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.05); border-radius: 3px;">üí¨ ${escapeHtml(log.message)}</div>` : ''}
                                    ${log.response ? `<div style="font-size: 0.85em; color: #28a745; margin-top: 5px; padding: 5px; background: rgba(40,167,69,0.1); border-radius: 3px;">‚úÖ ${escapeHtml(log.response.substring(0, 200))}${log.response.length > 200 ? '...' : ''}</div>` : ''}
                                    ${log.error ? `<div style="font-size: 0.85em; color: #dc3545; margin-top: 5px; padding: 5px; background: rgba(220,53,69,0.1); border-radius: 3px;">‚ùå ${escapeHtml(log.error)}</div>` : ''}
                                    ${log.toolName ? `<div style="font-size: 0.85em; color: #333; margin-top: 5px;">
                                        <strong>üîß ${escapeHtml(log.toolName)}</strong>
                                        ${log.toolExecutionTime ? `<span style="color: #666;"> (${log.toolExecutionTime}ms)</span>` : ''}
                                    </div>` : ''}
                                    ${log.tokenUsage ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                                        üí∞ Tokens: ${log.tokenUsage.totalTokens.toLocaleString()} (prompt: ${log.tokenUsage.promptTokens.toLocaleString()}, completion: ${log.tokenUsage.completionTokens.toLocaleString()})
                                        ${log.tokenCost ? `<br><span style="color: #ffc107; font-weight: bold;">üí∞ Custo: $${log.tokenCost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>` : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #999; text-align: right; min-width: 150px;">
                                    ${dateStr}
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 8px; font-size: 0.7em; color: #999; flex-wrap: wrap;">
                                ${log.socketId ? `<span>Socket: ${log.socketId.substring(0, 12)}...</span>` : ''}
                                ${log.threadId ? `<span>Thread: ${log.threadId.substring(0, 12)}...</span>` : ''}
                                ${log.runId ? `<span>Run: ${log.runId.substring(0, 12)}...</span>` : ''}
                            </div>
                            
                            ${log.metadata && Object.keys(log.metadata).length > 0 ? `
                                <details style="margin-top: 8px;">
                                    <summary style="font-size: 0.8em; color: #666; cursor: pointer;">üìã Mais detalhes</summary>
                                    <pre style="margin-top: 5px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 3px; font-size: 0.75em; overflow-x: auto;">${escapeHtml(JSON.stringify(log.metadata, null, 2))}</pre>
                                </details>
                            ` : ''}
                        </div>`;
                    });
                    
                    if (data.entries.length > 50) {
                        html += `<div style="text-align: center; padding: 10px; color: #666; font-size: 0.9em;">
                            Mostrando √∫ltimas 50 de ${data.entries.length} entradas
                        </div>`;
                    }
                } else {
                    html += `<div style="padding: 20px; text-align: center; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                        <div>Nenhum log registrado ainda.</div>
                    </div>`;
                }
                
                // √öltima atualiza√ß√£o
                if (data.lastUpdated) {
                    const lastUpdate = new Date(data.lastUpdated);
                    html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px; text-align: center; font-size: 0.85em; color: #666;">
                        √öltima atualiza√ß√£o: ${lastUpdate.toLocaleString('pt-BR')}
                    </div>`;
                }
                
                logsContent.innerHTML = html;
            } catch (error) {
                logsContent.innerHTML = `<div style="color: #dc3545; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px;">
                    Erro ao carregar logs: ${error.message}
                </div>`;
            }
        }
    </script>
</body>
</html>

