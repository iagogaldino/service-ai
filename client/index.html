<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DelsucIA - Socket.IO + OpenAI</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-card: #1e1e1e;
            --text-primary: #e4e4e4;
            --text-secondary: #a0a0a0;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --border-color: #2a2a2a;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px; /* Reduzido de 16px padr√£o */
            background: var(--bg-primary);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header / Navbar */
        .navbar {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            padding: 15px 25px; /* Reduzido */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            min-height: 50px; /* Reduzido */
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.5em; /* Reduzido de 1.8em */
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            border-top: 2px solid var(--border-color);
            border-bottom: 2px solid var(--border-color);
            min-height: 0;
            overflow: hidden;
            height: 0; /* Permite que flex: 1 funcione corretamente */
        }

        /* Menu Sidebar */
        .menu-sidebar {
            width: 220px; /* Reduzido de 250px */
            background: var(--bg-card);
            border-right: 2px solid var(--border-color);
            padding: 15px; /* Reduzido de 20px */
            overflow-y: auto;
            flex-shrink: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-card);
        }

        .menu-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .menu-sidebar::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 4px;
        }

        .menu-sidebar::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        .menu-sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        .menu-sidebar .menu-button {
            width: 100%;
            padding: 10px 14px; /* Reduzido */
            margin-bottom: 8px; /* Reduzido */
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Reduzido */
            color: var(--text-primary);
            font-size: 0.85em; /* Reduzido de 0.95em */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px; /* Reduzido */
        }

        .menu-sidebar .menu-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .menu-sidebar .menu-button.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Chat Area */
        .chat-area {
            width: 360px; /* Reduzido de 400px */
            background: var(--bg-card);
            border-right: 2px solid var(--border-color);
            padding: 15px; /* Reduzido de 20px */
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-height: 0;
            overflow: hidden;
            transition: width 0.3s ease, flex 0.3s ease;
        }

        /* Chat Area Expandida */
        .chat-area.expanded {
            width: auto;
            flex: 1;
            border-right: 2px solid var(--border-color);
        }

        /* Content Area - Escondida quando chat est√° expandido */
        .content-area.hidden {
            display: none;
        }

        .chat-area-header {
            margin-bottom: 12px; /* Reduzido */
            padding-bottom: 12px; /* Reduzido */
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-area-header h2 {
            margin: 0 0 8px 0; /* Reduzido */
            font-size: 1.1em; /* Reduzido de 1.2em */
            color: var(--text-primary);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            background: var(--bg-card);
            padding: 15px; /* Reduzido de 20px */
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-card);
            min-height: 0;
            position: relative;
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 4px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        .content-area::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }


        .content-panel {
            display: none;
            width: 100%;
        }

        .content-panel.active {
            display: block;
            width: 100%;
        }

        /* Monitor Panel Styles */
        #monitorConnectionsList {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-secondary);
        }

        #monitorConnectionsList::-webkit-scrollbar {
            width: 8px;
        }

        #monitorConnectionsList::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        #monitorConnectionsList::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        #monitorConnectionsList::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        #monitorEventsContainer {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-secondary);
        }

        #monitorEventsContainer::-webkit-scrollbar {
            width: 8px;
        }

        #monitorEventsContainer::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        #monitorEventsContainer::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        #monitorEventsContainer::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Footer */
        .footer {
            background: var(--bg-card);
            border-top: 2px solid var(--border-color);
            padding: 12px 25px; /* Reduzido */
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8em; /* Reduzido de 0.9em */
            flex-shrink: 0;
            min-height: 45px; /* Reduzido */
        }

        h1 {
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 8px; /* Reduzido */
            font-size: 1.8em; /* Reduzido de 2.2em */
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px; /* Reduzido */
            font-size: 0.85em; /* Reduzido de 0.9em */
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-actions button,
        .header-actions a {
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .header-actions button:hover:not(:disabled),
        .header-actions a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .status {
            padding: 10px 16px; /* Reduzido */
            border-radius: 10px; /* Reduzido */
            margin-bottom: 15px; /* Reduzido */
            text-align: center;
            font-weight: 500;
            font-size: 0.8em; /* Reduzido de 0.9em */
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .status.connected {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .status.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .chat-container {
            border: 1px solid var(--border-color);
            border-radius: 12px; /* Reduzido de 16px */
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 15px; /* Reduzido de 20px */
            margin-bottom: 15px; /* Reduzido */
            background: var(--bg-secondary);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-secondary);
            max-height: 100%;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        .message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
            backdrop-filter: blur(10px);
            font-size: 0.9em;
            display: block;
            box-sizing: border-box;
            width: fit-content;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            margin-left: auto;
            text-align: right;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .message.bot {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .message-label {
            font-size: 0.7em;
            opacity: 0.8;
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
        }

        .input-container {
            display: flex;
            gap: 10px; /* Reduzido */
            flex-shrink: 0;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px 14px; /* Reduzido */
            border: 1px solid var(--border-color);
            border-radius: 10px; /* Reduzido */
            font-size: 0.9em; /* Reduzido de 1em */
            outline: none;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        input[type="text"]:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        button {
            padding: 10px 20px; /* Reduzido */
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px; /* Reduzido */
            font-size: 0.9em; /* Reduzido de 1em */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        /* Loading spinner para o bot√£o */
        .button-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 10px;
        }

        .message.agent-action {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border-left: 3px solid var(--warning);
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .message.agent-selection {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
            border-left: 3px solid var(--info);
            font-size: 0.9em;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .message.agent-message {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
            border-left: 3px solid var(--accent-primary);
            font-size: 0.9em;
            margin: 10px 0;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .message.agent-message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .message.agent-message code {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message.terminal-output {
            background: #0a0a0a;
            border-left: 3px solid #4ec9b0;
            margin: 10px 0;
            border: 1px solid rgba(78, 201, 176, 0.3);
        }

        .message.terminal-output .message-label {
            background: rgba(78, 201, 176, 0.1);
            color: #4ec9b0;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
        }

        .terminal-content {
            scrollbar-width: thin;
            scrollbar-color: #4ec9b0 #0a0a0a;
        }

        .terminal-content::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .terminal-content::-webkit-scrollbar-thumb {
            background: #4ec9b0;
            border-radius: 4px;
        }

        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #5ed9c9;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Panel Styles */
        .panel-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Config Panel */
        .config-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.95em;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-bottom: 12px;
            font-family: inherit;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .config-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 16px;
            }

            h1 {
                font-size: 1.8em;
            }

            .header-actions {
                flex-direction: column;
            }

            .header-actions button,
            .header-actions a {
                width: 100%;
                justify-content: center;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <h1>DelsucIA</h1>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Menu Sidebar -->
        <aside class="menu-sidebar">
            <button class="menu-button active" onclick="showPanel('agents'); this.classList.add('active');">
                üìã Agentes
            </button>
            <button class="menu-button" onclick="showPanel('tokens'); this.classList.add('active');">
                üí∞ Tokens
            </button>
            <button class="menu-button" onclick="showPanel('logs'); this.classList.add('active');">
                üìù Logs
            </button>
            <button class="menu-button" onclick="showPanel('config'); this.classList.add('active');">
                ‚öôÔ∏è Config
            </button>
            <button class="menu-button" onclick="showPanel('monitor'); this.classList.add('active');">
                üîç Monitor
            </button>
        </aside>

        <!-- Chat Area -->
        <section class="chat-area">
            <div class="chat-area-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h2 style="margin: 0;">üí¨ Chat</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button id="expandChatBtn" onclick="toggleChatExpand()" style="padding: 6px 12px; background: rgba(99, 102, 241, 0.15); color: var(--accent-primary); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 4px;" onmouseover="this.style.background='rgba(99, 102, 241, 0.25)'" onmouseout="this.style.background='rgba(99, 102, 241, 0.15)'" title="Expandir chat">
                            <span id="expandChatIcon">‚¨å</span>
                        </button>
                        <button id="clearChatBtn" onclick="clearConversation()" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.15); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'" title="Limpar conversa">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                </div>
                <div id="status" class="status disconnected">Desconectado</div>
        </div>

        <div class="chat-container" id="chat">
        </div>

        <div class="input-container">
            <input 
                type="text" 
                id="messageInput" 
                    placeholder="Digite sua mensagem..."
                autocomplete="off"
            >
            <button id="sendButton" onclick="sendMessage()">Enviar</button>
        </div>
        </section>

        <!-- Content Area -->
        <section class="content-area">
            <!-- Agentes Panel -->
            <div id="agentsPanel" class="content-panel active">
                <div class="panel-header">
                    <h2>üìã Agentes Dispon√≠veis</h2>
                </div>
                <div id="agentsContent" style="color: var(--text-secondary);">Carregando agentes...</div>
    </div>

            <!-- Tokens Panel -->
            <div id="tokensPanel" class="content-panel">
                <div class="panel-header">
                    <h2>üí∞ Hist√≥rico de Tokens</h2>
                </div>
                <div style="margin: 15px; padding: 12px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; border-left: 4px solid var(--info);">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <div style="font-size: 1.2em;">‚ÑπÔ∏è</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">O que s√£o Tokens?</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary); line-height: 1.5;">
                                Tokens s√£o unidades de texto que a IA processa. Cada palavra ou parte de palavra √© convertida em tokens. 
                                O <strong style="color: var(--text-primary);">Prompt</strong> representa os tokens enviados para a IA (sua mensagem), 
                                enquanto o <strong style="color: var(--text-primary);">Completion</strong> representa os tokens retornados pela IA (resposta). 
                                O custo √© calculado baseado no modelo utilizado e na quantidade de tokens processados.
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tokensContent" style="color: var(--text-secondary);">Carregando tokens...</div>
            </div>

            <!-- Logs Panel -->
            <div id="logsPanel" class="content-panel">
                <div class="panel-header">
                    <h2>üìù Hist√≥rico de Logs</h2>
                </div>
                <div id="logsContent" style="color: var(--text-secondary);">Carregando logs...</div>
            </div>

            <!-- Config Panel -->
            <div id="configPanel" class="content-panel">
                <div class="panel-header">
                    <h2>‚öôÔ∏è Configura√ß√£o</h2>
                </div>
                <div id="configContent">
                    <div style="margin-bottom: 15px;">
                        <label class="config-label">OpenAI API Key</label>
                        <input 
                            type="password" 
                            id="apiKeyInput" 
                            placeholder="sk-..." 
                            class="config-input"
                        >
                        <div id="apiKeyStatus" style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);"></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label class="config-label">Porta (opcional)</label>
                        <input 
                            type="number" 
                            id="portInput" 
                            placeholder="3000" 
                            class="config-input"
                        >
                    </div>
                    <button 
                        onclick="saveConfig()" 
                        style="width: 100%; margin-top: 10px;"
                    >
                        üíæ Salvar Configura√ß√£o
                    </button>
                    <div id="configMessage" style="margin-top: 12px; padding: 12px; border-radius: 10px; display: none; font-size: 0.9em;"></div>
                </div>
            </div>

            <!-- Monitor Panel -->
            <div id="monitorPanel" class="content-panel">
                <div class="panel-header">
                    <h2>üîç Monitor de Conex√µes</h2>
                </div>
                <div id="monitorContent" style="display: flex; flex-direction: column; min-height: 0;">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-shrink: 0;">
                        <button onclick="refreshMonitorConnections()" style="padding: 10px 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Atualizar Conex√µes
                        </button>
                        <button id="stopMonitorBtn" onclick="stopMonitorMonitoring()" style="padding: 10px 20px; background: rgba(239, 68, 68, 0.2); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">
                            Parar Monitoramento
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 15px; flex: 1; min-height: 0; overflow: hidden;">
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; min-height: 0;">
                            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                                <h3 style="margin: 0 0 5px 0; color: var(--text-primary); font-size: 1.1em;">Conex√µes Ativas</h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.85em;">Clique em uma conex√£o para monitorar</p>
                            </div>
                            <div id="monitorConnectionsList" style="flex: 1; overflow-y: auto; min-height: 0; color: var(--text-secondary);">
                                Carregando conex√µes...
                            </div>
                        </div>
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; overflow: hidden; display: flex; flex-direction: column; min-height: 0;">
                            <div id="monitorTitle" style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); flex-shrink: 0;">
                                Selecione uma conex√£o para monitorar
                            </div>
                            <div id="monitorEventsContainer" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                                <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                                    üëà Clique em uma conex√£o √† esquerda para ver os eventos em tempo real
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        Desenvolvido por iago_galdino@hotmail.com
    </footer>

    <script>
        const socket = io('http://localhost:3000');
        const chatContainer = document.getElementById('chat');
        const statusDiv = document.getElementById('status');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        // Armazena tokens totais para atualiza√ß√£o em tempo real
        let currentTotalTokens = {
            promptTokens: 0,
            completionTokens: 0,
            totalTokens: 0,
            totalCost: { promptCost: 0, completionCost: 0, totalCost: 0 }
        };
        
        // Armazena tokens salvos do tokens.json (base)
        let savedTotalTokens = {
            promptTokens: 0,
            completionTokens: 0,
            totalTokens: 0,
            totalCost: { promptCost: 0, completionCost: 0, totalCost: 0 }
        };
        
        // Armazena tokens acumulados da thread atual (n√£o salvos ainda)
        let currentThreadTokens = {
            promptTokens: 0,
            completionTokens: 0,
            totalTokens: 0
        };

        // Eventos de conex√£o
        socket.on('connect', () => {
            statusDiv.textContent = 'Conectado';
            statusDiv.className = 'status connected';
            // myMonitorSocketId ser√° atualizado no escopo do monitor
            if (typeof window.updateMonitorSocketId === 'function') {
                window.updateMonitorSocketId(socket.id);
            }
            
            // Tenta restaurar thread anterior do localStorage
            // Usa um pequeno delay para garantir que o servidor est√° pronto
            setTimeout(() => {
                const savedThreadId = localStorage.getItem('delsucia_threadId');
                if (savedThreadId) {
                    console.log('Tentando restaurar thread:', savedThreadId);
                    socket.emit('restore_thread', { threadId: savedThreadId });
                }
            }, 10);
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'Desconectado';
            statusDiv.className = 'status disconnected';
        });

        // Recebe informa√ß√£o sobre qual agente foi selecionado
        socket.on('agent_selected', (data) => {
            addAgentSelection(data.agentName, data.description);
        });

        // Recebe resposta do servidor
        socket.on('response', async (data) => {
            removeLoading();
            removeAgentActions();
            setButtonLoading(false);
            const senderLabel = data.agentName ? `IA (${data.agentName})` : 'IA';
            
            // Adiciona mensagem principal
            addMessage(senderLabel, data.message, 'bot');
            
            // Quando recebemos response, os tokens j√° foram salvos no servidor
            // Recarrega tokens salvos e reseta currentThreadTokens
            if (data.accumulatedTokenUsage) {
                // Recarrega tokens salvos (que agora incluem os tokens que acabaram de ser salvos)
                await reloadSavedTokens();
                
                // Reseta currentThreadTokens porque os tokens j√° foram salvos
                // Mas mantemos acumulado para a pr√≥xima mensagem
                // Na verdade, n√£o resetamos completamente, apenas atualizamos para o pr√≥ximo ciclo
                // Os tokens da thread atual ainda n√£o foram salvos completamente at√© a pr√≥xima mensagem
                // Ent√£o mantemos currentThreadTokens para mostrar em tempo real
                
                // Atualiza o card de tokens se o painel estiver vis√≠vel
                const tokensPanel = document.getElementById('tokensPanel');
                if (tokensPanel && tokensPanel.classList.contains('active')) {
                    updateTokensCard();
                }
            }
            
            // Adiciona informa√ß√µes de tokens de forma compacta se dispon√≠veis
            if (data.tokenUsage || data.accumulatedTokenUsage) {
                const tokenDiv = document.createElement('div');
                tokenDiv.className = 'message';
                tokenDiv.style.background = 'rgba(16, 185, 129, 0.15)';
                tokenDiv.style.border = '1px solid rgba(16, 185, 129, 0.3)';
                tokenDiv.style.color = 'var(--success)';
                tokenDiv.style.marginTop = '5px';
                tokenDiv.style.padding = '6px 10px';
                tokenDiv.style.fontSize = '0.75em';
                
                let tokenContent = '<div style="display: flex; justify-content: space-between; align-items: center;">';
                tokenContent += '<span>üí∞ Tokens:</span>';
                
                if (data.tokenUsage) {
                    tokenContent += `<span style="margin-left: 10px;">Esta: ${data.tokenUsage.totalTokens}</span>`;
                }
                
                if (data.accumulatedTokenUsage) {
                    tokenContent += `<span style="margin-left: 10px; font-weight: 600; color: var(--success);">Total: ${data.accumulatedTokenUsage.totalTokens}</span>`;
                }
                
                tokenContent += '</div>';
                tokenDiv.innerHTML = tokenContent;
                chatContainer.appendChild(tokenDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });

        // Recebe erros
        // Recebe notifica√ß√£o de que a API key precisa ser configurada
        socket.on('config_required', (data) => {
            removeLoading();
            setButtonLoading(false);
            const configMessage = document.createElement('div');
            configMessage.className = 'message';
            configMessage.style.background = 'rgba(245, 158, 11, 0.15)';
            configMessage.style.border = '2px solid rgba(245, 158, 11, 0.3)';
            configMessage.style.color = 'var(--warning)';
            configMessage.style.borderRadius = '10px';
            configMessage.style.padding = '15px';
            configMessage.style.marginBottom = '15px';
            configMessage.innerHTML = `
                <div class="message-label" style="color: var(--warning); font-weight: bold; margin-bottom: 10px;">${escapeHtml(data.message)}</div>
                <div style="color: var(--text-secondary); margin-bottom: 10px;">
                    ${escapeHtml(data.details)}
                </div>
                <div style="color: var(--text-secondary); margin-bottom: 15px; font-weight: 500;">
                    ${escapeHtml(data.action)}
                </div>
                <button 
                    onclick="toggleConfigPanel()" 
                    style="background: linear-gradient(135deg, var(--warning), #f97316); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;"
                >
                    ‚öôÔ∏è Configurar API Key
                </button>
            `;
            chatContainer.appendChild(configMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Recebe notifica√ß√£o de que a API key foi configurada
        socket.on('config_saved', (data) => {
            const successMessage = document.createElement('div');
            successMessage.className = 'message';
            successMessage.style.background = 'rgba(16, 185, 129, 0.15)';
            successMessage.style.border = '2px solid rgba(16, 185, 129, 0.3)';
            successMessage.style.color = 'var(--success)';
            successMessage.style.borderRadius = '10px';
            successMessage.style.padding = '15px';
            successMessage.style.marginBottom = '15px';
            successMessage.innerHTML = `
                <div class="message-label" style="color: var(--success); font-weight: bold; margin-bottom: 10px;">${escapeHtml(data.message)}</div>
                <div style="color: var(--text-secondary);">
                    ${escapeHtml(data.details)}
                </div>
            `;
            chatContainer.appendChild(successMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Recebe notifica√ß√£o de que a API key est√° inv√°lida
        socket.on('api_key_invalid', (data) => {
            removeLoading();
            setButtonLoading(false);
            const invalidKeyMessage = document.createElement('div');
            invalidKeyMessage.className = 'message';
            invalidKeyMessage.style.background = 'rgba(239, 68, 68, 0.15)';
            invalidKeyMessage.style.border = '2px solid rgba(239, 68, 68, 0.3)';
            invalidKeyMessage.style.color = 'var(--error)';
            invalidKeyMessage.style.borderRadius = '10px';
            invalidKeyMessage.style.padding = '15px';
            invalidKeyMessage.style.marginBottom = '15px';
            invalidKeyMessage.innerHTML = `
                <div class="message-label" style="color: var(--error); font-weight: bold; margin-bottom: 10px;">${escapeHtml(data.message)}</div>
                <div style="color: var(--text-secondary); margin-bottom: 10px;">
                    ${escapeHtml(data.details)}
                </div>
                <div style="color: var(--text-secondary); margin-bottom: 15px; font-weight: 500;">
                    ${escapeHtml(data.action)}
                </div>
                <div style="color: var(--warning); font-size: 0.85em; margin-bottom: 10px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 5px;">
                    <strong>Detalhes do erro:</strong><br>
                    ${escapeHtml(data.errorMessage)}
                </div>
                <button 
                    onclick="toggleConfigPanel()" 
                    style="background: linear-gradient(135deg, var(--error), #dc2626); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95em;"
                >
                    ‚öôÔ∏è Corrigir API Key
                </button>
            `;
            chatContainer.appendChild(invalidKeyMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        socket.on('error', (data) => {
            removeLoading();
            removeAgentActions();
            setButtonLoading(false);
            addMessage('Erro', data.message, 'bot');
        });

        // Recebe a√ß√µes do agente em tempo real
        socket.on('agent_action', (data) => {
            addAgentAction(data.action);
        });

        // Recebe confirma√ß√£o de conclus√£o de a√ß√£o
        socket.on('agent_action_complete', (data) => {
            updateAgentAction(data.action, data.success, data.result);
        });

        // Logs de debug removidos - apenas logs no servidor

        // Recebe mensagens trocadas pelos agentes
        socket.on('agent_message', (data) => {
            addAgentMessage(data);
        });

        // Carrega conversa salva quando conectar
        socket.on('load_conversation', (data) => {
            console.log('üìö Evento load_conversation recebido:', data);
            const chatContainer = document.getElementById('chat');
            if (!chatContainer) {
                console.error('‚ùå chatContainer n√£o encontrado');
                return;
            }
            
            if (!data || !data.messages) {
                console.log('‚ö†Ô∏è Nenhuma mensagem recebida ou dados inv√°lidos');
                return;
            }
            
            if (data.messages.length === 0) {
                console.log('‚ö†Ô∏è Array de mensagens vazio');
                return;
            }

            console.log(`üìö Carregando ${data.messages.length} mensagem(ns) salva(s)...`);
            
            // Limpa o chat antes de carregar
            chatContainer.innerHTML = '';

            // Carrega cada mensagem salva
            data.messages.forEach((msg, index) => {
                if (msg.role === 'user') {
                    addMessage('Voc√™', msg.content, 'user');
                } else if (msg.role === 'assistant') {
                    const senderLabel = msg.agentName ? `IA (${msg.agentName})` : 'IA';
                    addMessage(senderLabel, msg.content, 'bot');
                }
                console.log(`‚úÖ Mensagem ${index + 1}/${data.messages.length} carregada: ${msg.role}`);
            });

            // Scroll para o final
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
            
            console.log('‚úÖ Todas as mensagens foram carregadas');
        });

        // Handler quando conversa √© limpa
        socket.on('conversation_cleared', (data) => {
            const chatContainer = document.getElementById('chat');
            if (chatContainer) {
                chatContainer.innerHTML = '';
            }
            // Atualiza threadId no localStorage se uma nova thread foi criada
            if (data.newThreadId) {
                localStorage.setItem('delsucia_threadId', data.newThreadId);
                console.log('Conversa limpa e nova thread criada:', data.newThreadId);
            } else {
                // Se n√£o recebeu novo threadId, remove do localStorage
                localStorage.removeItem('delsucia_threadId');
            }
            console.log('Conversa limpa:', data.message);
        });

        // Handler quando thread √© criada - salva no localStorage
        socket.on('thread_created', (data) => {
            if (data.threadId) {
                localStorage.setItem('delsucia_threadId', data.threadId);
                console.log('Thread criada e salva:', data.threadId);
                // Reseta tokens da thread atual quando uma nova thread √© criada
                currentThreadTokens = {
                    promptTokens: 0,
                    completionTokens: 0,
                    totalTokens: 0
                };
            }
        });

        // Handler quando thread √© restaurada - atualiza localStorage
        socket.on('thread_restored', (data) => {
            if (data.threadId) {
                localStorage.setItem('delsucia_threadId', data.threadId);
                console.log('Thread restaurada:', data.threadId);
            }
        });

        // Recebe informa√ß√µes de tokens em tempo real
        socket.on('token_usage', (data) => {
            // Atualiza tokens acumulados da thread atual (n√£o salvos ainda)
            if (data.accumulated) {
                currentThreadTokens = {
                    promptTokens: data.accumulated.promptTokens,
                    completionTokens: data.accumulated.completionTokens,
                    totalTokens: data.accumulated.totalTokens
                };
                
                // Atualiza o card de tokens se o painel estiver vis√≠vel
                // N√£o recarrega tokens salvos aqui porque ainda n√£o foram salvos no servidor
                const tokensPanel = document.getElementById('tokensPanel');
                if (tokensPanel && tokensPanel.classList.contains('active')) {
                    updateTokensCard();
                }
            }
            
            // Adiciona uma mensagem de token usage na interface
            const tokenDiv = document.createElement('div');
            tokenDiv.className = 'message token-usage';
            tokenDiv.style.background = 'rgba(245, 158, 11, 0.15)';
            tokenDiv.style.border = '1px solid rgba(245, 158, 11, 0.3)';
            tokenDiv.style.color = 'var(--warning)';
            tokenDiv.style.fontSize = '0.75em';
            tokenDiv.style.padding = '6px 10px';
            tokenDiv.style.marginBottom = '5px';
            tokenDiv.innerHTML = `
                <div class="message-label" style="font-size: 0.85em;">üí∞ Tokens</div>
                <div style="font-size: 0.85em;">
                    Mensagem: ${data.tokens.totalTokens} | Total: ${data.accumulated.totalTokens}
                </div>
            `;
            chatContainer.appendChild(tokenDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove ap√≥s 5 segundos para n√£o poluir a interface
            setTimeout(() => {
                if (tokenDiv && tokenDiv.parentNode) {
                    tokenDiv.remove();
                }
            }, 5000);
        });

        // Recebe sa√≠da do terminal em tempo real
        socket.on('terminal_output', (data) => {
            addTerminalOutput(data);
        });

        function addMessage(sender, message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="message-label">${sender}</div>
                <div>${message}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.className = 'loading';
            loadingDiv.textContent = 'Processando...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        function addAgentAction(actionText) {
            // Remove a√ß√µes anteriores se existirem
            removeAgentActions();
            
            const actionDiv = document.createElement('div');
            actionDiv.className = 'message agent-action';
            actionDiv.id = 'agent-action';
            actionDiv.innerHTML = `
                <div class="message-label">ü§ñ Agente</div>
                <div>${actionText}</div>
            `;
            chatContainer.appendChild(actionDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateAgentAction(actionText, success, resultPreview) {
            const actionDiv = document.getElementById('agent-action');
            if (actionDiv) {
                const icon = success ? '‚úÖ' : '‚ùå';
                let content = `${icon} ${actionText}`;
                if (resultPreview) {
                    content += `<br><small style="opacity: 0.7;">Resultado: ${escapeHtml(resultPreview)}</small>`;
                }
                actionDiv.innerHTML = `
                    <div class="message-label">ü§ñ Agente</div>
                    <div>${content}</div>
                `;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Remove ap√≥s 3 segundos
                setTimeout(() => {
                    if (actionDiv && actionDiv.parentNode) {
                        actionDiv.remove();
                    }
                }, 3000);
            }
        }


        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Container para o terminal
        let terminalContainer = null;

        function addTerminalOutput(data) {
            // Se for in√≠cio de um novo comando, limpa o terminal anterior
            if (data.type === 'start') {
                if (terminalContainer && terminalContainer.parentNode) {
                    terminalContainer.remove();
                }
                terminalContainer = null;
            }

            // Cria container do terminal se n√£o existir
            if (!terminalContainer) {
                terminalContainer = document.createElement('div');
                terminalContainer.className = 'message terminal-output';
                terminalContainer.id = 'terminal-output';
                terminalContainer.innerHTML = `
                    <div class="message-label">üíª Terminal</div>
                    <div class="terminal-content" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; white-space: pre-wrap; max-height: 500px; overflow-y: auto; line-height: 1.5;"></div>
                `;
                chatContainer.appendChild(terminalContainer);
            }

            const terminalContent = terminalContainer.querySelector('.terminal-content');
            
            if (!terminalContent) return;

            // Processa o conte√∫do baseado no tipo
            let content = '';
            let color = '#d4d4d4'; // Cor padr√£o (cinza claro)

            switch (data.type) {
                case 'start':
                    color = '#4ec9b0'; // Verde √°gua
                    content = escapeHtml(data.content);
                    break;
                case 'stdout':
                    color = '#d4d4d4'; // Cinza claro (sa√≠da normal)
                    content = escapeHtml(data.content);
                    break;
                case 'stderr':
                    color = '#f48771'; // Laranja (erros/avisos)
                    content = escapeHtml(data.content);
                    break;
                case 'success':
                    color = '#4ec9b0'; // Verde √°gua
                    content = escapeHtml(data.content);
                    break;
                case 'error':
                    color = '#f48771'; // Laranja/vermelho
                    content = escapeHtml(data.content);
                    break;
                default:
                    content = escapeHtml(data.content);
            }

            // Adiciona o conte√∫do com a cor apropriada
            const span = document.createElement('span');
            span.style.color = color;
            span.textContent = content;
            terminalContent.appendChild(span);

            // Auto-scroll para o final
            terminalContent.scrollTop = terminalContent.scrollHeight;

            // Se o comando terminou, marca mas mant√©m vis√≠vel
            if (data.isComplete) {
                // Adiciona uma linha separadora visual
                const separator = document.createElement('div');
                separator.style.marginTop = '10px';
                separator.style.paddingTop = '10px';
                separator.style.borderTop = '1px solid #4ec9b0';
                separator.style.opacity = '0.3';
                terminalContent.appendChild(separator);
            }
        }

        function addAgentMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message';
            
            let icon = 'üí¨';
            let title = 'Mensagem do Agente';
            let content = '';
            
            if (data.type === 'user') {
                icon = 'üë§';
                title = 'Mensagem do Usu√°rio (enviada ao agente)';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">üìù Mensagem:</div>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">${escapeHtml(data.message)}</div>`;
            } else if (data.type === 'assistant') {
                icon = 'ü§ñ';
                title = 'Resposta do Agente';
                
                // Adiciona informa√ß√µes de tokens se dispon√≠veis (compacto)
                let tokenInfo = '';
                if (data.tokenUsage) {
                    tokenInfo = `<div style="margin-top: 5px; padding: 4px 6px; background: rgba(16, 185, 129, 0.15); border-radius: 3px; font-size: 0.7em; color: var(--text-secondary);">
                        üí∞ ${data.tokenUsage.totalTokens} tokens
                    </div>`;
                }
                
                content = `<div style="font-weight: 600; margin-bottom: 5px;">üí¨ Resposta:</div>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px; white-space: pre-wrap;">${escapeHtml(data.message)}</div>
                    ${tokenInfo}`;
            } else if (data.type === 'function_calls') {
                icon = 'üîß';
                title = 'Fun√ß√µes que o Agente quer Executar';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">Fun√ß√µes solicitadas:</div>`;
                data.toolCalls.forEach((tc, index) => {
                    content += `<div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                        <strong>${index + 1}. ${tc.functionName}</strong><br>
                        <small>Argumentos:</small><pre style="font-size: 0.85em; margin: 5px 0; overflow-x: auto;">${escapeHtml(JSON.stringify(tc.arguments, null, 2))}</pre>
                    </div>`;
                });
            } else if (data.type === 'function_result') {
                icon = '‚úÖ';
                title = `Resultado da Fun√ß√£o: ${data.functionName}`;
                content = `<div style="font-weight: 600; margin-bottom: 5px;">Fun√ß√£o executada: <code>${data.functionName}</code> (${data.executionTime}ms)</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Argumentos:</div>
                    <pre style="font-size: 0.85em; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; margin-bottom: 5px; overflow-x: auto; color: var(--text-primary);">${escapeHtml(JSON.stringify(data.arguments, null, 2))}</pre>
                    <div style="font-weight: 600; margin-bottom: 5px;">Resultado:</div>
                    <div style="background: ${data.success ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)'}; padding: 8px; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${escapeHtml(data.result)}</div>`;
            } else if (data.type === 'function_outputs') {
                icon = 'üì§';
                title = 'Resultados Enviados de Volta ao Agente';
                content = `<div style="font-weight: 600; margin-bottom: 5px;">${data.outputsCount} resultado(s) enviado(s):</div>`;
                data.outputs.forEach((output, index) => {
                    content += `<div style="background: rgba(102, 126, 234, 0.1); padding: 8px; border-radius: 5px; margin-bottom: 5px;">
                        <strong>${index + 1}. Tool Call ID: ${output.toolCallId}</strong><br>
                        <small>Tamanho: ${output.outputLength} caracteres</small><br>
                        <div style="margin-top: 5px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-size: 0.9em;">${escapeHtml(output.output)}</div>
                    </div>`;
                });
            }
            
            let detailsHtml = '';
            if (data.details && Object.keys(data.details).length > 0) {
                detailsHtml = '<details style="margin-top: 5px;"><summary style="cursor: pointer; font-size: 0.85em; opacity: 0.7;">Detalhes t√©cnicos</summary><pre style="font-size: 0.75em; margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow-x: auto;">' + 
                    escapeHtml(JSON.stringify(data.details, null, 2)) + '</pre></details>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-label">${icon} ${title}</div>
                <div>${content}${detailsHtml}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeAgentActions() {
            const actionDiv = document.getElementById('agent-action');
            if (actionDiv) {
                actionDiv.remove();
            }
        }

        function addAgentSelection(agentName, description) {
            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'message agent-selection';
            selectionDiv.innerHTML = `
                <div class="message-label">ü§ñ Usando Agente</div>
                <div><strong>${agentName}</strong>: ${description}</div>
            `;
            chatContainer.appendChild(selectionDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Remove ap√≥s 3 segundos
            setTimeout(() => {
                if (selectionDiv && selectionDiv.parentNode) {
                    selectionDiv.remove();
                }
            }, 3000);
        }

        function clearConversation() {
            if (confirm('Tem certeza que deseja limpar a conversa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                socket.emit('clear_conversation');
            }
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('Voc√™', message, 'user');
            messageInput.value = '';
            setButtonLoading(true);

            socket.emit('message', { message: message });
        }

        // Fun√ß√£o para ativar loading no bot√£o
        function setButtonLoading(isLoading) {
            if (isLoading) {
                sendButton.disabled = true;
                sendButton.innerHTML = '<span class="button-loading"></span>';
            } else {
                sendButton.disabled = false;
                sendButton.innerHTML = 'Enviar';
                messageInput.focus();
            }
        }

        // Envia mensagem ao pressionar Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Fun√ß√£o para expandir/colapsar o chat
        function toggleChatExpand() {
            const chatArea = document.querySelector('.chat-area');
            const contentArea = document.querySelector('.content-area');
            const expandIcon = document.getElementById('expandChatIcon');
            
            if (chatArea && contentArea && expandIcon) {
                const isExpanded = chatArea.classList.contains('expanded');
                
                if (isExpanded) {
                    // Colapsa o chat
                    chatArea.classList.remove('expanded');
                    contentArea.classList.remove('hidden');
                    expandIcon.textContent = '‚¨å';
                    expandIcon.parentElement.title = 'Expandir chat';
                } else {
                    // Expande o chat
                    chatArea.classList.add('expanded');
                    contentArea.classList.add('hidden');
                    expandIcon.textContent = '‚¨ç';
                    expandIcon.parentElement.title = 'Colapsar chat';
                }
            }
        }

        // Fun√ß√£o para mostrar painel espec√≠fico
        function showPanel(panelName) {
            // Para o intervalo de atualiza√ß√£o do monitor se estiver ativo
            if (monitorRefreshInterval) {
                clearInterval(monitorRefreshInterval);
                monitorRefreshInterval = null;
            }
            
            // Colapsa o chat se estiver expandido
            const chatArea = document.querySelector('.chat-area');
            const contentArea = document.querySelector('.content-area');
            const expandIcon = document.getElementById('expandChatIcon');
            
            if (chatArea && chatArea.classList.contains('expanded')) {
                chatArea.classList.remove('expanded');
                if (contentArea) {
                    contentArea.classList.remove('hidden');
                }
                if (expandIcon) {
                    expandIcon.textContent = '‚¨å';
                    expandIcon.parentElement.title = 'Expandir chat';
                }
            }
            
            // Remove active de todos os pain√©is
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active de todos os bot√µes do menu
            document.querySelectorAll('.menu-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Ativa o painel selecionado
            const panel = document.getElementById(panelName + 'Panel');
            if (panel) {
                panel.classList.add('active');
            }
            
            // Ativa o bot√£o correspondente
            const buttons = document.querySelectorAll('.menu-button');
            buttons.forEach((button, index) => {
                const panelNames = ['agents', 'tokens', 'logs', 'config', 'monitor'];
                if (panelNames[index] === panelName) {
                    button.classList.add('active');
                }
            });
            
            // Carrega conte√∫do se necess√°rio
            switch(panelName) {
                case 'agents':
                    loadAgents();
                    break;
                case 'tokens':
                    loadTokens();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'config':
                    loadConfig();
                    break;
                case 'monitor':
                    loadMonitorConnections();
                    // Atualiza conex√µes a cada 5 segundos quando o painel est√° ativo
                    monitorRefreshInterval = setInterval(() => {
                        const panel = document.getElementById('monitorPanel');
                        if (panel && panel.classList.contains('active')) {
                            loadMonitorConnections();
                        } else {
                            // Para o intervalo se o painel n√£o estiver mais ativo
                            clearInterval(monitorRefreshInterval);
                            monitorRefreshInterval = null;
                        }
                    }, 5000);
                    break;
            }
        }

        // Fun√ß√£o para alternar visibilidade da lista de agentes (mantida para compatibilidade)
        function toggleAgentsList() {
            showPanel('agents');
        }

        // Carrega e exibe a lista de agentes
        async function loadAgents() {
            const agentsContent = document.getElementById('agentsContent');
            agentsContent.innerHTML = 'Carregando agentes...';
            
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                let html = '';
                
                // Main Selector
                if (data.mainSelector) {
                    let toolsHtml = '';
                    if (data.mainSelector.tools && data.mainSelector.tools.length > 0) {
                        toolsHtml = `<div style="margin-top: 8px; padding: 6px; background: rgba(99, 102, 241, 0.15); border-radius: 5px; font-size: 0.85em;">
                            <strong>üîß Ferramentas (${data.mainSelector.tools.length}):</strong><br>
                            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${data.mainSelector.tools.map(tool => `<span style="background: rgba(99, 102, 241, 0.25); padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${escapeHtml(tool)}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                    
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: rgba(99, 102, 241, 0.2); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px;">
                        <strong>üéØ Main Selector</strong><br>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            <strong>${escapeHtml(data.mainSelector.name)}</strong><br>
                            ${escapeHtml(data.mainSelector.description)}
                            ${toolsHtml}
                        </div>
                    </div>`;
                }
                
                // Grupos
                if (data.groups && data.groups.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong style="font-size: 1.1em;">üì¶ Grupos</strong></div>';
                    
                    data.groups.forEach(group => {
                        html += `<div style="margin-bottom: 15px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; border-left: 4px solid var(--success);">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--success);">${escapeHtml(group.name)}</div>
                            
                            <div style="margin-left: 15px; margin-bottom: 8px; padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 5px;">
                                <strong>üéØ Orquestrador:</strong> ${escapeHtml(group.orchestrator.name)}<br>
                                <small style="color: var(--text-secondary);">${escapeHtml(group.orchestrator.description)}</small>`;
                        
                        if (group.orchestrator.tools && group.orchestrator.tools.length > 0) {
                            html += `<div style="margin-top: 6px; font-size: 0.85em;">
                                <strong>üîß Ferramentas (${group.orchestrator.tools.length}):</strong><br>
                                <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${group.orchestrator.tools.map(tool => `<span style="background: rgba(102, 126, 234, 0.2); padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${escapeHtml(tool)}</span>`).join('')}
                                </div>
                            </div>`;
                        }
                        
                        html += `</div>
                            <div style="margin-left: 15px;">
                                <strong>ü§ñ Agentes (${group.agents.length}):</strong><br>`;
                        
                        group.agents.forEach(agent => {
                            let agentToolsHtml = '';
                            if (agent.tools && agent.tools.length > 0) {
                                agentToolsHtml = `<div style="margin-top: 4px; font-size: 0.8em;">
                                    <strong>üîß Ferramentas:</strong>
                                    <div style="margin-top: 3px; display: flex; flex-wrap: wrap; gap: 3px;">
                                        ${agent.tools.map(tool => `<span style="background: rgba(0,0,0,0.1); padding: 2px 5px; border-radius: 3px; font-size: 0.75em;">${escapeHtml(tool)}</span>`).join('')}
                                    </div>
                                </div>`;
                            }
                            
                            html += `<div style="margin-top: 5px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; font-size: 0.9em;">
                                <strong style="color: var(--text-primary);">${escapeHtml(agent.name)}</strong><br>
                                <small style="color: var(--text-secondary);">${escapeHtml(agent.description)}</small>
                                ${agentToolsHtml}
                            </div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                }
                
                // Fallback Agent
                if (data.fallbackAgent) {
                    let fallbackToolsHtml = '';
                    if (data.fallbackAgent.tools && data.fallbackAgent.tools.length > 0) {
                        fallbackToolsHtml = `<div style="margin-top: 8px; padding: 6px; background: rgba(251, 191, 36, 0.15); border-radius: 5px; font-size: 0.85em;">
                            <strong>üîß Ferramentas (${data.fallbackAgent.tools.length}):</strong><br>
                            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${data.fallbackAgent.tools.map(tool => `<span style="background: rgba(251, 191, 36, 0.25); padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${escapeHtml(tool)}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                    
                    html += `<div style="margin-top: 15px; padding: 10px; background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); color: var(--text-primary); border-radius: 8px;">
                        <strong>üîÑ Fallback Agent</strong><br>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            <strong>${escapeHtml(data.fallbackAgent.name)}</strong><br>
                            ${escapeHtml(data.fallbackAgent.description)}
                            ${fallbackToolsHtml}
                        </div>
                    </div>`;
                }
                
                html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: center; font-size: 0.85em; color: var(--text-secondary);">
                    Total: <strong>${data.total}</strong> agente(s) configurado(s)
                </div>`;
                
                agentsContent.innerHTML = html;
            } catch (error) {
                agentsContent.innerHTML = `<div style="color: var(--error); padding: 10px; background: rgba(239, 68, 68, 0.15); border-radius: 5px;">
                    Erro ao carregar agentes: ${error.message}
                </div>`;
            }
        }

        // Fun√ß√£o para alternar visibilidade do hist√≥rico de tokens (mantida para compatibilidade)
        function toggleTokensList() {
            showPanel('tokens');
        }

        // Fun√ß√£o para calcular custo (mesma l√≥gica do servidor)
        function calculateTokenCost(promptTokens, completionTokens, model = 'gpt-4-turbo-preview') {
            const MODEL_PRICING = {
                'gpt-4-turbo-preview': { prompt: 0.01, completion: 0.03 },
                'gpt-4': { prompt: 0.03, completion: 0.06 },
                'gpt-4-0125-preview': { prompt: 0.01, completion: 0.03 },
                'gpt-4-1106-preview': { prompt: 0.01, completion: 0.03 },
                'gpt-3.5-turbo': { prompt: 0.0005, completion: 0.0015 },
                'gpt-3.5-turbo-16k': { prompt: 0.003, completion: 0.004 }
            };
            
            const pricing = MODEL_PRICING[model] || MODEL_PRICING['gpt-4-turbo-preview'];
            const promptCost = (promptTokens / 1000) * pricing.prompt;
            const completionCost = (completionTokens / 1000) * pricing.completion;
            const totalCost = promptCost + completionCost;
            
            return {
                promptCost: Math.round(promptCost * 10000) / 10000,
                completionCost: Math.round(completionCost * 10000) / 10000,
                totalCost: Math.round(totalCost * 10000) / 10000
            };
        }

        // Fun√ß√£o para calcular tokens totais (salvos + thread atual)
        // Mas s√≥ soma currentThreadTokens se ainda n√£o foram salvos
        function calculateTotalTokens() {
            // Se os tokens da thread atual j√° foram salvos (detectado quando recarrega o painel),
            // ent√£o currentThreadTokens j√° est√° inclu√≠do em savedTotalTokens
            // Por isso, s√≥ somamos se currentThreadTokens > 0 e n√£o foram salvos ainda
            
            // Vamos usar uma abordagem diferente: quando recarregamos o painel,
            // comparamos o total salvo com o que temos na thread atual
            // Se os tokens da thread atual s√£o maiores que zero, significa que ainda n√£o foram salvos
            
            // Na verdade, a melhor abordagem √©: quando loadTokens() √© chamado,
            // resetamos currentThreadTokens para 0, porque os tokens salvos j√° incluem tudo
            // E quando recebemos token_usage, atualizamos currentThreadTokens apenas para tokens ainda n√£o salvos
            
            return {
                promptTokens: savedTotalTokens.promptTokens + currentThreadTokens.promptTokens,
                completionTokens: savedTotalTokens.completionTokens + currentThreadTokens.completionTokens,
                totalTokens: savedTotalTokens.totalTokens + currentThreadTokens.totalTokens
            };
        }
        
        // Fun√ß√£o para recarregar tokens salvos e resetar thread atual
        async function reloadSavedTokens() {
            try {
                const response = await fetch('/api/tokens');
                const data = await response.json();
                
                if (data.totalTokens) {
                    const totalCost = data.totalCost || { promptCost: 0, completionCost: 0, totalCost: 0 };
                    
                    // Atualiza tokens salvos (base do tokens.json)
                    savedTotalTokens = {
                        promptTokens: data.totalTokens.promptTokens,
                        completionTokens: data.totalTokens.completionTokens,
                        totalTokens: data.totalTokens.totalTokens,
                        totalCost: totalCost
                    };
                    
                    // Reset currentThreadTokens porque agora os tokens salvos j√° incluem tudo
                    // (a menos que haja uma nova mensagem sendo processada)
                    // Na verdade, n√£o resetamos aqui para manter os tokens em tempo real
                    // O reset s√≥ acontece quando uma nova thread √© criada
                }
            } catch (error) {
                console.error('Erro ao recarregar tokens salvos:', error);
            }
        }

        // Fun√ß√£o para atualizar o card de tokens totais
        function updateTokensCard() {
            const tokensCard = document.getElementById('tokensTotalCard');
            if (!tokensCard) return;
            
            // Calcula total (salvos + thread atual)
            const totalTokens = calculateTotalTokens();
            const cost = calculateTokenCost(
                totalTokens.promptTokens,
                totalTokens.completionTokens
            );
            
            tokensCard.innerHTML = `
                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">üí∞ Total de Tokens</div>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Prompt</div>
                        <div style="font-size: 1.3em; font-weight: bold;">${totalTokens.promptTokens.toLocaleString()}</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${cost.promptCost.toFixed(4)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Completion</div>
                        <div style="font-size: 1.3em; font-weight: bold;">${totalTokens.completionTokens.toLocaleString()}</div>
                        <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${cost.completionCost.toFixed(4)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9;">Total</div>
                        <div style="font-size: 1.5em; font-weight: bold;">${totalTokens.totalTokens.toLocaleString()}</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-top: 3px; font-weight: bold;">$${cost.totalCost.toFixed(4)}</div>
                    </div>
                </div>
            `;
        }

        // Carrega e exibe o hist√≥rico de tokens
        async function loadTokens() {
            const tokensContent = document.getElementById('tokensContent');
            tokensContent.innerHTML = 'Carregando tokens...';
            
            try {
                const response = await fetch('/api/tokens');
                const data = await response.json();
                
                let html = '';
                
                // Total de tokens
                if (data.totalTokens) {
                    const totalCost = data.totalCost || { promptCost: 0, completionCost: 0, totalCost: 0 };
                    
                    // Atualiza tokens salvos (base do tokens.json)
                    // Quando recarregamos, os tokens salvos j√° incluem todas as threads anteriores
                    // Mas podem n√£o incluir os tokens da thread atual se ainda n√£o foram salvos
                    savedTotalTokens = {
                        promptTokens: data.totalTokens.promptTokens,
                        completionTokens: data.totalTokens.completionTokens,
                        totalTokens: data.totalTokens.totalTokens,
                        totalCost: totalCost
                    };
                    
                    // Calcula total (salvos + thread atual)
                    // Se os tokens da thread atual j√° foram salvos, currentThreadTokens ser√° 0
                    // Caso contr√°rio, somamos para mostrar em tempo real
                    const totalTokens = calculateTotalTokens();
                    const totalCostCalculated = calculateTokenCost(
                        totalTokens.promptTokens,
                        totalTokens.completionTokens
                    );
                    
                    html += `<div id="tokensTotalCard" style="margin-bottom: 20px; padding: 15px; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); color: var(--text-primary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 8px;">üí∞ Total de Tokens</div>
                        <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Prompt</div>
                                <div style="font-size: 1.3em; font-weight: bold;">${totalTokens.promptTokens.toLocaleString()}</div>
                                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${totalCostCalculated.promptCost.toFixed(4)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Completion</div>
                                <div style="font-size: 1.3em; font-weight: bold;">${totalTokens.completionTokens.toLocaleString()}</div>
                                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">$${totalCostCalculated.completionCost.toFixed(4)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9em; opacity: 0.9;">Total</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${totalTokens.totalTokens.toLocaleString()}</div>
                                <div style="font-size: 0.9em; opacity: 0.9; margin-top: 3px; font-weight: bold;">$${totalCostCalculated.totalCost.toFixed(4)}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Hist√≥rico de entradas
                if (data.entries && data.entries.length > 0) {
                    html += `<div style="margin-bottom: 10px;"><strong style="font-size: 1.1em;">üìú Hist√≥rico (${data.entries.length} intera√ß√£o${data.entries.length > 1 ? '√µes' : ''})</strong></div>`;
                    
                    // Mostra as √∫ltimas 20 entradas (mais recentes primeiro)
                    const entries = data.entries.slice().reverse().slice(0, 20);
                    
                    entries.forEach((entry, index) => {
                        const date = new Date(entry.timestamp);
                        const dateStr = date.toLocaleString('pt-BR');
                        
                        html += `<div style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; border-left: 4px solid var(--warning);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: var(--text-primary);">${escapeHtml(entry.agentName)}</strong>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">${escapeHtml(entry.message)}</div>
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-secondary); text-align: right;">
                                    ${dateStr}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px;">Esta Intera√ß√£o</div>
                                    <div style="font-size: 0.85em; color: var(--text-primary);">
                                        <span style="color: var(--info);">Prompt:</span> ${entry.tokenUsage.promptTokens.toLocaleString()}<br>
                                        <span style="color: var(--success);">Completion:</span> ${entry.tokenUsage.completionTokens.toLocaleString()}<br>
                                        <span style="color: var(--text-primary); font-weight: bold;">Total:</span> ${entry.tokenUsage.totalTokens.toLocaleString()}
                                        ${entry.cost ? `<br><span style="color: var(--warning); font-weight: bold; margin-top: 3px; display: block;">üí∞ Custo: $${entry.cost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>
                                </div>
                                <div style="padding: 8px; background: rgba(16, 185, 129, 0.15); border-radius: 5px;">
                                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px;">Acumulado</div>
                                    <div style="font-size: 0.85em; color: var(--text-primary);">
                                        <span style="color: var(--info);">Prompt:</span> ${entry.accumulatedTokenUsage.promptTokens.toLocaleString()}<br>
                                        <span style="color: var(--success);">Completion:</span> ${entry.accumulatedTokenUsage.completionTokens.toLocaleString()}<br>
                                        <span style="color: var(--text-primary); font-weight: bold;">Total:</span> ${entry.accumulatedTokenUsage.totalTokens.toLocaleString()}
                                        ${entry.accumulatedCost ? `<br><span style="color: var(--warning); font-weight: bold; margin-top: 3px; display: block;">üí∞ Custo: $${entry.accumulatedCost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-size: 0.7em; color: var(--text-secondary); margin-top: 6px;">
                                Thread: ${entry.threadId.substring(0, 20)}...
                            </div>
                        </div>`;
                    });
                    
                    if (data.entries.length > 20) {
                        html += `<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 0.9em;">
                            Mostrando √∫ltimas 20 de ${data.entries.length} intera√ß√µes
                        </div>`;
                    }
                } else {
                    html += `<div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                        <div>Nenhuma intera√ß√£o registrada ainda.</div>
                    </div>`;
                }
                
                // √öltima atualiza√ß√£o
                if (data.lastUpdated) {
                    const lastUpdate = new Date(data.lastUpdated);
                    html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: center; font-size: 0.85em; color: var(--text-secondary);">
                        √öltima atualiza√ß√£o: ${lastUpdate.toLocaleString('pt-BR')}
                    </div>`;
                }
                
                tokensContent.innerHTML = html;
            } catch (error) {
                tokensContent.innerHTML = `<div style="color: var(--error); padding: 10px; background: rgba(239, 68, 68, 0.15); border-radius: 5px;">
                    Erro ao carregar tokens: ${error.message}
                </div>`;
            }
        }

        // Fun√ß√£o para alternar visibilidade do hist√≥rico de logs (mantida para compatibilidade)
        function toggleLogsList() {
            showPanel('logs');
        }

        // Fun√ß√£o para obter cor baseada no tipo de log
        function getLogTypeColor(type) {
            const colors = {
                'connection': '#28a745',
                'disconnection': '#dc3545',
                'agent_selection': '#667eea',
                'message_sent': '#17a2b8',
                'message_received': '#17a2b8',
                'tool_execution': '#ffc107',
                'tool_result': '#ffc107',
                'run_status': '#6c757d',
                'error': '#dc3545',
                'response': '#28a745',
                'token_usage': '#ffc107',
                'monitoring': '#6f42c1'
            };
            return colors[type] || '#6c757d';
        }

        // Fun√ß√£o para obter √≠cone baseado no tipo de log
        function getLogTypeIcon(type) {
            const icons = {
                'connection': 'üîå',
                'disconnection': 'üîå',
                'agent_selection': 'ü§ñ',
                'message_sent': 'üì§',
                'message_received': 'üì•',
                'tool_execution': 'üîß',
                'tool_result': '‚úÖ',
                'run_status': '‚öôÔ∏è',
                'error': '‚ùå',
                'response': 'üí¨',
                'token_usage': 'üí∞',
                'monitoring': 'üëÅÔ∏è'
            };
            return icons[type] || 'üìù';
        }

        // Carrega e exibe o hist√≥rico de logs
        async function loadLogs() {
            const logsContent = document.getElementById('logsContent');
            logsContent.innerHTML = 'Carregando logs...';
            
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                let html = '';
                
                // Estat√≠sticas
                if (data.statistics) {
                    html += `<div style="margin-bottom: 20px; padding: 15px; background: rgba(59, 130, 246, 0.2); border: 1px solid var(--info); color: var(--text-primary); border-radius: 8px;">
                        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">üìä Estat√≠sticas</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Conex√µes</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalConnections || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Mensagens</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalMessages || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Tools</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalToolExecutions || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Erros</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${data.statistics.totalErrors || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.9em; opacity: 0.9;">Tokens</div>
                                <div style="font-size: 1.5em; font-weight: bold;">${(data.statistics.totalTokens || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Hist√≥rico de logs
                if (data.entries && data.entries.length > 0) {
                    html += `<div style="margin-bottom: 10px;">
                        <strong style="font-size: 1.1em;">üìú Logs (${data.entries.length} entrada${data.entries.length > 1 ? 's' : ''})</strong>
                        <div style="margin-top: 5px; font-size: 0.85em; color: var(--text-secondary);">
                            Mostrando √∫ltimas 50 entradas (mais recentes primeiro)
                        </div>
                    </div>`;
                    
                    // Mostra as √∫ltimas 50 entradas (mais recentes primeiro)
                    const logs = data.entries.slice().reverse().slice(0, 50);
                    
                    logs.forEach((log, index) => {
                        const date = new Date(log.timestamp);
                        const dateStr = date.toLocaleString('pt-BR');
                        const typeColor = getLogTypeColor(log.type);
                        const typeIcon = getLogTypeIcon(log.type);
                        
                        html += `<div style="margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; border-left: 4px solid ${typeColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <span style="font-size: 1.2em;">${typeIcon}</span>
                                        <strong style="color: ${typeColor}; text-transform: uppercase; font-size: 0.9em;">${escapeHtml(log.type)}</strong>
                                        ${log.agentName ? `<span style="font-size: 0.85em; color: var(--text-secondary);">ü§ñ ${escapeHtml(log.agentName)}</span>` : ''}
                                    </div>
                                    ${log.message ? `<div style="font-size: 0.85em; color: var(--text-primary); margin-top: 5px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 3px;">üí¨ ${escapeHtml(log.message)}</div>` : ''}
                                    ${log.response ? `<div style="font-size: 0.85em; color: var(--success); margin-top: 5px; padding: 5px; background: rgba(16,185,129,0.15); border-radius: 3px;">‚úÖ ${escapeHtml(log.response.substring(0, 200))}${log.response.length > 200 ? '...' : ''}</div>` : ''}
                                    ${log.error ? `<div style="font-size: 0.85em; color: var(--error); margin-top: 5px; padding: 5px; background: rgba(239,68,68,0.15); border-radius: 3px;">‚ùå ${escapeHtml(log.error)}</div>` : ''}
                                    ${log.toolName ? `<div style="font-size: 0.85em; color: var(--text-primary); margin-top: 5px;">
                                        <strong>üîß ${escapeHtml(log.toolName)}</strong>
                                        ${log.toolExecutionTime ? `<span style="color: var(--text-secondary);"> (${log.toolExecutionTime}ms)</span>` : ''}
                                    </div>` : ''}
                                    ${log.tokenUsage ? `<div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">
                                        üí∞ Tokens: ${log.tokenUsage.totalTokens.toLocaleString()} (prompt: ${log.tokenUsage.promptTokens.toLocaleString()}, completion: ${log.tokenUsage.completionTokens.toLocaleString()})
                                        ${log.tokenCost ? `<br><span style="color: var(--warning); font-weight: bold;">üí∞ Custo: $${log.tokenCost.totalCost.toFixed(4)}</span>` : ''}
                                    </div>` : ''}
                                </div>
                                <div style="font-size: 0.75em; color: var(--text-secondary); text-align: right; min-width: 150px;">
                                    ${dateStr}
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 8px; font-size: 0.7em; color: var(--text-secondary); flex-wrap: wrap;">
                                ${log.socketId ? `<span>Socket: ${log.socketId.substring(0, 12)}...</span>` : ''}
                                ${log.threadId ? `<span>Thread: ${log.threadId.substring(0, 12)}...</span>` : ''}
                                ${log.runId ? `<span>Run: ${log.runId.substring(0, 12)}...</span>` : ''}
                            </div>
                            
                            ${log.metadata && Object.keys(log.metadata).length > 0 ? `
                                <details style="margin-top: 8px;">
                                    <summary style="font-size: 0.8em; color: var(--text-secondary); cursor: pointer;">üìã Mais detalhes</summary>
                                    <pre style="margin-top: 5px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 3px; font-size: 0.75em; overflow-x: auto; color: var(--text-primary);">${escapeHtml(JSON.stringify(log.metadata, null, 2))}</pre>
                                </details>
                            ` : ''}
                        </div>`;
                    });
                    
                    if (data.entries.length > 50) {
                        html += `<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 0.9em;">
                            Mostrando √∫ltimas 50 de ${data.entries.length} entradas
                        </div>`;
                    }
                } else {
                    html += `<div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                        <div>Nenhum log registrado ainda.</div>
                    </div>`;
                }
                
                // √öltima atualiza√ß√£o
                if (data.lastUpdated) {
                    const lastUpdate = new Date(data.lastUpdated);
                    html += `<div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px; text-align: center; font-size: 0.85em; color: var(--text-secondary);">
                        √öltima atualiza√ß√£o: ${lastUpdate.toLocaleString('pt-BR')}
                    </div>`;
                }
                
                logsContent.innerHTML = html;
            } catch (error) {
                logsContent.innerHTML = `<div style="color: var(--error); padding: 10px; background: rgba(239, 68, 68, 0.15); border-radius: 5px;">
                    Erro ao carregar logs: ${error.message}
                </div>`;
            }
        }

        // Fun√ß√£o para alternar visibilidade do painel de configura√ß√£o (mantida para compatibilidade)
        function toggleConfigPanel() {
            showPanel('config');
        }

        // ============================================
        // FUN√á√ïES DO MONITOR
        // ============================================
        let currentMonitoringSocketId = null;
        let monitorConnections = [];
        let monitorEvents = [];
        let myMonitorSocketId = null;
        
        // Fun√ß√£o global para atualizar o ID do socket do monitor
        window.updateMonitorSocketId = (socketId) => {
            myMonitorSocketId = socketId;
            console.log('Monitor Socket ID atualizado:', socketId);
        };

        // Carrega lista de conex√µes para monitoramento
        let monitorRefreshInterval = null;
        
        async function loadMonitorConnections() {
            const list = document.getElementById('monitorConnectionsList');
            if (!list) {
                console.error('Elemento monitorConnectionsList n√£o encontrado');
                return;
            }
            
            list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">üîÑ Carregando conex√µes...</div>';
            
            try {
                const response = await fetch('/api/connections');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Conex√µes recebidas da API:', data);
                monitorConnections = data.connections || [];
                console.log('Total de conex√µes:', monitorConnections.length);
                console.log('My Monitor Socket ID:', myMonitorSocketId);
                
                if (monitorConnections.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">Nenhuma conex√£o ativa no momento</div>';
                    return;
                }
                
                renderMonitorConnections();
            } catch (error) {
                console.error('Erro ao carregar conex√µes:', error);
                if (list) {
                    list.innerHTML = `<div style="color: var(--error); padding: 15px; background: rgba(239, 68, 68, 0.15); border-radius: 8px; border-left: 4px solid var(--error);">
                        <strong>‚ùå Erro ao carregar conex√µes</strong><br>
                        <small>${error.message}</small><br>
                        <small style="margin-top: 10px; display: block;">Verifique se o servidor est√° rodando e tente novamente.</small>
                    </div>`;
                }
            }
        }

        // Renderiza lista de conex√µes
        function renderMonitorConnections() {
            const list = document.getElementById('monitorConnectionsList');
            if (!list) {
                console.error('Elemento monitorConnectionsList n√£o encontrado');
                return;
            }
            
            console.log('Renderizando conex√µes. Total:', monitorConnections.length);
            console.log('My Monitor Socket ID:', myMonitorSocketId);
            
            // Mostra todas as conex√µes, incluindo a pr√≥pria (√∫til para debug)
            // Mas marca a pr√≥pria conex√£o de forma diferente
            if (monitorConnections.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Nenhuma conex√£o ativa no momento</div>';
                return;
            }

            list.innerHTML = monitorConnections.map(conn => {
                const connectedAt = new Date(conn.connectedAt);
                const lastActivity = new Date(conn.lastActivity);
                const isActive = conn.socketId === currentMonitoringSocketId;
                const isOwnConnection = conn.socketId === myMonitorSocketId;
                
                return `
                    <div onclick="selectMonitorConnection('${conn.socketId}')" style="background: ${isActive ? 'rgba(99, 102, 241, 0.2)' : 'var(--bg-tertiary)'}; border: 1px solid ${isActive ? 'var(--accent-primary)' : isOwnConnection ? 'rgba(251, 191, 36, 0.5)' : 'var(--border-color)'}; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; position: relative;">
                        ${isOwnConnection ? '<div style="position: absolute; top: 8px; right: 8px; padding: 2px 6px; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border-radius: 4px; font-size: 0.7em; font-weight: 600;">VOC√ä</div>' : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: ${isOwnConnection ? '#fbbf24' : 'var(--accent-primary)'}; font-size: 0.9em;">${conn.socketId.substring(0, 20)}...</span>
                            <span style="padding: 4px 8px; background: rgba(16, 185, 129, 0.2); color: var(--success); border-radius: 5px; font-size: 0.75em; font-weight: 600;">Online</span>
                        </div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">
                            <div><strong>Thread:</strong> ${conn.threadId ? conn.threadId.substring(0, 20) + '...' : 'N/A'}</div>
                            <div><strong>Mensagens:</strong> ${conn.messageCount || 0}</div>
                            <div><strong>Conectado:</strong> ${formatMonitorTime(connectedAt)}</div>
                            <div><strong>√öltima atividade:</strong> ${formatMonitorTime(lastActivity)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Formata tempo relativo
        function formatMonitorTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return `${diff}s atr√°s`;
            if (diff < 3600) return `${Math.floor(diff / 60)}min atr√°s`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h atr√°s`;
            return date.toLocaleString('pt-BR');
        }

        // Seleciona uma conex√£o para monitorar
        function selectMonitorConnection(socketId) {
            if (currentMonitoringSocketId === socketId) return;
            
            currentMonitoringSocketId = socketId;
            monitorEvents = [];
            
            // Inicia monitoramento
            socket.emit('start_monitoring', { targetSocketId: socketId });
            
            // Atualiza UI
            const monitorTitle = document.getElementById('monitorTitle');
            const stopBtn = document.getElementById('stopMonitorBtn');
            const eventsContainer = document.getElementById('monitorEventsContainer');
            
            if (monitorTitle) {
                monitorTitle.innerHTML = `<strong style="color: var(--accent-primary);">Monitorando:</strong> ${socketId.substring(0, 30)}...`;
            }
            if (stopBtn) {
                stopBtn.style.display = 'block';
            }
            if (eventsContainer) {
                eventsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Aguardando eventos...</div>';
            }
            
            renderMonitorConnections();
        }

        // Para monitoramento
        function stopMonitorMonitoring() {
            if (currentMonitoringSocketId) {
                socket.emit('stop_monitoring');
                currentMonitoringSocketId = null;
                monitorEvents = [];
                
                const monitorTitle = document.getElementById('monitorTitle');
                const stopBtn = document.getElementById('stopMonitorBtn');
                const eventsContainer = document.getElementById('monitorEventsContainer');
                
                if (monitorTitle) {
                    monitorTitle.innerHTML = 'Selecione uma conex√£o para monitorar';
                }
                if (stopBtn) {
                    stopBtn.style.display = 'none';
                }
                if (eventsContainer) {
                    eventsContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">üëà Clique em uma conex√£o √† esquerda para ver os eventos em tempo real</div>';
                }
                
                renderMonitorConnections();
            }
        }

        // Atualiza lista de conex√µes
        function refreshMonitorConnections() {
            loadMonitorConnections();
        }

        // Renderiza eventos do monitor
        function renderMonitorEvents() {
            const container = document.getElementById('monitorEventsContainer');
            if (!container) return;

            if (monitorEvents.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">Nenhum evento ainda. Aguardando atividade...<br><small>Envie uma mensagem na conex√£o monitorada para ver os eventos</small></div>';
                return;
            }

            container.innerHTML = monitorEvents.map(event => {
                try {
                    let eventClass = getMonitorEventClass(event.event);
                    
                    if (event.event === 'agent_message' && event.data && event.data.type) {
                        if (event.data.type === 'user') {
                            eventClass = 'user';
                        } else if (event.data.type === 'assistant') {
                            eventClass = 'assistant';
                        }
                    }
                    
                    const eventIcon = getMonitorEventIcon(event.event);
                    const eventData = formatMonitorEventData(event);
                    const borderColor = getMonitorBorderColor(eventClass);
                    
                    return `
                        <div style="background: var(--bg-tertiary); border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: 600; color: ${borderColor}; font-size: 0.9em;">${eventIcon} ${event.event}</span>
                                <span style="font-size: 0.75em; color: var(--text-secondary);">${new Date(event.timestamp).toLocaleTimeString('pt-BR')}</span>
                            </div>
                            <div style="color: var(--text-primary); white-space: pre-wrap; word-wrap: break-word;">${eventData}</div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Erro ao renderizar evento:', error, event);
                    return `<div style="background: rgba(239, 68, 68, 0.15); border-left: 4px solid var(--error); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600; color: var(--error); font-size: 0.9em;">‚ùå Erro</span>
                            <span style="font-size: 0.75em; color: var(--text-secondary);">${new Date(event.timestamp).toLocaleTimeString('pt-BR')}</span>
                        </div>
                        <div style="color: var(--text-primary);">Erro ao renderizar evento: ${error.message}</div>
                    </div>`;
                }
            }).join('');
            
            // Scroll para o final
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // Obt√©m classe CSS baseada no tipo de evento
        function getMonitorEventClass(eventType) {
            if (!eventType) return 'info';
            if (eventType.includes('action')) return 'action';
            if (eventType.includes('error')) return 'error';
            if (eventType.includes('connection') || eventType.includes('monitoring')) return 'info';
            if (eventType === 'response') return 'assistant';
            if (eventType === 'agent_selected') return 'info';
            return 'info';
        }

        // Obt√©m √≠cone baseado no tipo de evento
        function getMonitorEventIcon(eventType) {
            if (eventType.includes('message')) return 'üí¨';
            if (eventType.includes('action')) return '‚öôÔ∏è';
            if (eventType.includes('response')) return '‚úÖ';
            if (eventType.includes('agent_selected')) return 'ü§ñ';
            if (eventType.includes('error')) return '‚ùå';
            return 'üìã';
        }

        // Obt√©m cor da borda baseada na classe
        function getMonitorBorderColor(eventClass) {
            const colors = {
                'user': 'var(--accent-primary)',
                'assistant': 'var(--success)',
                'action': 'var(--warning)',
                'error': 'var(--error)',
                'info': 'var(--info)'
            };
            return colors[eventClass] || 'var(--accent-primary)';
        }

        // Formata dados do evento para exibi√ß√£o
        function formatMonitorEventData(event) {
            const data = event.data;
            
            if (event.event === 'agent_message') {
                if (data.type === 'user') {
                    return `<strong style="color: var(--accent-primary);">Mensagem do Usu√°rio:</strong><br><div style="margin-top: 5px;">${escapeHtml(data.message)}</div>`;
                } else if (data.type === 'assistant') {
                    return `<strong style="color: var(--success);">Resposta do Assistente:</strong><br><div style="margin-top: 5px; white-space: pre-wrap;">${escapeHtml(data.message)}</div>`;
                } else if (data.type === 'function_calls') {
                    return `<strong>Fun√ß√µes Solicitadas:</strong><pre style="margin-top: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 0.85em;">${escapeHtml(JSON.stringify(data.toolCalls, null, 2))}</pre>`;
                } else if (data.type === 'function_result') {
                    const resultPreview = data.result.length > 2000 ? data.result.substring(0, 2000) + '\n\n... (resultado truncado, muito longo)' : data.result;
                    return `<strong>Resultado da Fun√ß√£o:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">${escapeHtml(data.functionName)}</code><br>
                            <strong>Execu√ß√£o:</strong> ${data.executionTime}ms<br>
                            <strong>Resultado:</strong><pre style="margin-top: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-size: 0.85em;">${escapeHtml(resultPreview)}</pre>`;
                } else if (data.type === 'function_outputs') {
                    return `<strong>Outputs Enviados:</strong> ${data.outputsCount}<pre style="margin-top: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-size: 0.85em;">${escapeHtml(JSON.stringify(data.outputs, null, 2))}</pre>`;
                }
            } else if (event.event === 'agent_action') {
                return `<strong>A√ß√£o:</strong><br><div style="margin-top: 5px;">${escapeHtml(data.action)}</div><br>
                        <strong>Fun√ß√£o:</strong> <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">${escapeHtml(data.functionName)}</code>`;
            } else if (event.event === 'agent_action_complete') {
                return `<strong>A√ß√£o Conclu√≠da:</strong><br><div style="margin-top: 5px;">${escapeHtml(data.action)}</div><br>
                        <strong>Status:</strong> ${data.success ? '‚úÖ Sucesso' : '‚ùå Erro'}<br>
                        <strong>Preview:</strong><pre style="margin-top: 5px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-size: 0.85em;">${escapeHtml(data.result)}</pre>`;
            } else if (event.event === 'agent_selected') {
                return `<strong>Agente Selecionado:</strong> ${escapeHtml(data.agentName)}<br>
                        <strong>Descri√ß√£o:</strong><br><div style="margin-top: 5px;">${escapeHtml(data.description)}</div>`;
            } else if (event.event === 'response') {
                return `<strong>Resposta Final:</strong><br><div style="margin-top: 5px; white-space: pre-wrap;">${escapeHtml(data.message)}</div>`;
            } else if (event.event === 'connection' || event.event === 'connection_info') {
                const connectedAt = data.connectedAt ? new Date(data.connectedAt).toLocaleString('pt-BR') : 'N/A';
                const lastActivity = data.lastActivity ? new Date(data.lastActivity).toLocaleString('pt-BR') : 'N/A';
                return `<strong>Informa√ß√µes da Conex√£o:</strong><br>
                        <strong>Socket ID:</strong> <span style="word-break: break-all;">${data.socketId || 'N/A'}</span><br>
                        <strong>Thread ID:</strong> <span style="word-break: break-all;">${data.threadId || 'N/A'}</span><br>
                        <strong>Conectado em:</strong> ${connectedAt}<br>
                        <strong>√öltima atividade:</strong> ${lastActivity}<br>
                        <strong>Mensagens:</strong> ${data.messageCount || 0}<br>
                        ${data.userAgent ? `<strong>User Agent:</strong><br><span style="word-break: break-all;">${escapeHtml(data.userAgent)}</span><br>` : ''}
                        ${data.ipAddress ? `<strong>IP:</strong> ${data.ipAddress}` : ''}`;
            } else if (event.event === 'disconnect') {
                return `<strong>Conex√£o Desconectada:</strong> ${data.socketId}`;
            } else if (event.event === 'monitoring_started') {
                return `<strong>Monitoramento Iniciado:</strong><br>
                        <strong>Monitorando:</strong><br><span style="word-break: break-all;">${data.targetSocketId}</span>`;
            }
            
            return `<pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; max-height: 500px; overflow-y: auto; font-size: 0.85em;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
        }

        // Eventos do Socket.IO para monitoramento
        socket.on('monitoring_started', (data) => {
            console.log('Monitoramento iniciado:', data);
            monitorEvents.push({
                event: 'monitoring_started',
                data: data,
                timestamp: new Date().toISOString()
            });
            renderMonitorEvents();
        });

        socket.on('monitored_event', (data) => {
            console.log('Evento recebido:', data.event, 'para target:', data.targetSocketId, 'monitorando:', currentMonitoringSocketId);
            if (data.targetSocketId === currentMonitoringSocketId) {
                console.log('Evento aceito e adicionado:', data.event);
                monitorEvents.push(data);
                if (monitorEvents.length > 500) {
                    monitorEvents.shift(); // Mant√©m apenas os √∫ltimos 500 eventos
                }
                renderMonitorEvents();
            }
        });

        socket.on('monitoring_stopped', () => {
            console.log('Monitoramento parado');
        });

        socket.on('monitoring_error', (data) => {
            console.error('Erro no monitoramento:', data);
            const eventsContainer = document.getElementById('monitorEventsContainer');
            if (eventsContainer) {
                eventsContainer.innerHTML = `<div style="background: rgba(239, 68, 68, 0.15); border-left: 4px solid var(--error); border-radius: 8px; padding: 15px; color: var(--error);">
                    <strong>Erro:</strong> ${data.message}
                </div>`;
            }
        });

        // Carrega conte√∫do inicial ao carregar a p√°gina
        window.onload = () => {
            messageInput.focus();
            loadAgents(); // Carrega agentes por padr√£o
            // myMonitorSocketId ser√° atualizado no evento 'connect'
        };

        // Carrega configura√ß√£o atual
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                const apiKeyInput = document.getElementById('apiKeyInput');
                const portInput = document.getElementById('portInput');
                const apiKeyStatus = document.getElementById('apiKeyStatus');
                
                if (data.hasApiKey) {
                    apiKeyInput.value = '';
                    apiKeyInput.placeholder = data.apiKeyPreview || 'sk-...';
                    apiKeyStatus.innerHTML = `<span style="color: var(--success);">‚úÖ API Key configurada: ${data.apiKeyPreview}</span>`;
                    if (data.lastUpdated) {
                        const date = new Date(data.lastUpdated);
                        apiKeyStatus.innerHTML += `<br><span style="color: var(--text-secondary); font-size: 0.85em;">Atualizada em: ${date.toLocaleString('pt-BR')}</span>`;
                    }
                } else {
                    apiKeyInput.value = '';
                    apiKeyInput.placeholder = 'sk-...';
                    apiKeyStatus.innerHTML = `<span style="color: var(--error);">‚ö†Ô∏è API Key n√£o configurada</span>`;
                }
                
                portInput.value = data.port || '3000';
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o:', error);
            }
        }

        // Salva configura√ß√£o
        async function saveConfig() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const portInput = document.getElementById('portInput');
            const configMessage = document.getElementById('configMessage');
            
            const apiKey = apiKeyInput.value.trim();
            const port = parseInt(portInput.value) || null;
            
            if (!apiKey) {
                configMessage.style.display = 'block';
                configMessage.style.background = 'rgba(239, 68, 68, 0.15)';
                configMessage.style.color = 'var(--error)';
                configMessage.style.border = '1px solid var(--error)';
                configMessage.textContent = '‚ùå Por favor, insira uma API Key';
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                configMessage.style.display = 'block';
                configMessage.style.background = 'rgba(239, 68, 68, 0.15)';
                configMessage.style.color = 'var(--error)';
                configMessage.style.border = '1px solid var(--error)';
                configMessage.textContent = '‚ùå API Key inv√°lida. Deve come√ßar com "sk-"';
                return;
            }
            
            try {
                configMessage.style.display = 'block';
                configMessage.style.background = 'rgba(59, 130, 246, 0.15)';
                configMessage.style.color = 'var(--info)';
                configMessage.style.border = '1px solid var(--info)';
                configMessage.textContent = '‚è≥ Salvando configura√ß√£o...';
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        openaiApiKey: apiKey,
                        port: port
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    configMessage.style.background = 'rgba(16, 185, 129, 0.15)';
                    configMessage.style.color = 'var(--success)';
                    configMessage.style.border = '1px solid var(--success)';
                    configMessage.textContent = `‚úÖ ${data.message}`;
                    
                    // Limpa o campo de API key por seguran√ßa
                    apiKeyInput.value = '';
                    apiKeyInput.placeholder = data.apiKeyPreview;
                    
                    // Recarrega status
                    setTimeout(() => {
                        loadConfig();
                    }, 1000);
                } else {
                    configMessage.style.background = 'rgba(220, 53, 69, 0.1)';
                    configMessage.style.color = '#dc3545';
                    configMessage.style.border = '1px solid #dc3545';
                    configMessage.textContent = `‚ùå ${data.error || 'Erro ao salvar configura√ß√£o'}`;
                }
            } catch (error) {
                configMessage.style.display = 'block';
                configMessage.style.background = 'rgba(239, 68, 68, 0.15)';
                configMessage.style.color = 'var(--error)';
                configMessage.style.border = '1px solid var(--error)';
                configMessage.textContent = `‚ùå Erro ao salvar configura√ß√£o: ${error.message}`;
            }
        }
    </script>
</body>
</html>

